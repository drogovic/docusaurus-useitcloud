---
id: 10020
title: Guide d'Exploitation
description: UseITcloud documentation 3.2.0-12
sidebar_position: 2
---

## Présentation de la plateforme
### Description et Architecture
*Use IT Cloud* appartient à la famille des CMP (Cloud Management Platform), cette plateforme permet de modéliser et de gérer vos déploiements dans des environnements hybrides combinant des clouds publics et privés. <br></br>
La plateforme est fondée sur un modèle d’abstraction des ressources des divers fournisseurs de cloud avec lesquels elle s’interface. <br></br>
*Use IT Cloud* assure l’automatisation et l’orchestration des déploiements des applications tout en permettant de gérer leur cycle de vie complet.<br></br>
*Use IT Cloud* fédère les différents services proposés par les CSP (Cloud Service Provider), il propose également des services complémentaires, agnostiques aux fournisseurs de clouds. Son architecture simplifiée est illustrée sur la figure suivante :
![Image](/img_fr/img_UIC_Guide_Exploitation/image002.png#bordered)

D’un point de vue conceptuel, le produit est composé des blocs suivants :

- Un bloc appelé **uic-core**, composé de plusieurs micro-services spécialisés chacun dans une fonction déterminée. Voici une liste des fonctions notables assurées par ce bloc :
	- La gestion des différents Clouds supportés par UIC. Cette gestion est assurée par un ensemble de connecteurs dédiés chacun à un Cloud,
	- L’interfaçage avec des services IT tiers comme Ansible, Chef, LDAP, Puppet, Zabbix, etc. Cette gestion est assurée par un ensemble de connecteurs dédiés à chacune des catégories,
	- Un service de base de données In-memory basé sur Redis, 
	- Un agent installable sur les machines virtuelles, permettant de personnaliser ces machines et d’exécuter des commandes à distance sur ces machines,
	- Un service de sécurité qui permet de sécuriser les échanges de données entre les différents services,
- Un bloc appelé **portail UIC (UIC dashboard)** : Ce bloc est constitué des composants suivants :
	- Un serveur web, pour UIC il s’agit de apache2, avec une configuration répondant aux besoins du portail UIC, notamment concernant la sécurité,
	- Un framework php, pour UIC, il s’agit de Laravel,
	- Une base de données pour stocker les données persistantes du portail, il s’agit de Mariadb,
	- Un tableau de bord constitué d’une collection de formulaires, de leurs contrôleurs et des modèles de données qui leur sont associés. Ce tableau de bord utilise les APIs exposés par le bloc uic-core pour effectuer toutes les fonctions concernant la gestion des ressources Cloud (déploiement, libération, instantané, etc.) et les fonctions concernant la gestion des outils IT tiers,
	- Un service d’accès en mode web aux shells des machines virtuelles, basé sur l’outil ‘’shell in a box’’,
	- Un service de notification des navigateurs en temps réel, permettant d’informer l’utilisateur sur les résultats des actions déclenchées. 
- Un bloc appelé **API UIC**, composé des éléments suivants :
	- Un serveur d’API UIC dont l’architecture est de type REST, pour gérer les ressources exposées par UIC,
	- Un framework python appelé Flask, pour gérer en frontal les requêtes standards HTTP avant leur redirection au serveur UIC. Ce serveur est configuré en tant que service accessible en HTTPS, sous contrôle du serveur web Apache2.

Les détails sur les ressources et les opérations exposées par l’API de UIC font l’objet d’un document dédié, livrable sur demande. 

Les paragraphes et les chapitres suivants fournissent les détails sur la configuration, l’administration et l’utilisation de chacun des blocs énumérés ci-dessus. 

## Fournisseurs de cloud
Use IT Cloud prend en charge le pilotage des ressources IaaS exposées par les technologies de virtualisation et les Clouds suivants :
- VMware vSphere et vCloud,
- Les clouds privés basés sur OpenStack®,
- Les clouds publics comme Amazon Web Services, Microsoft Azure, Orange Flexible Engine, Outscale, Oracle Cloud, OVH, Scaleway et Google Cloud Platform. 

### Les outils IT tiers
En plus de l’interfaçage avec les fournisseurs de cloud public et privé, la plateforme *UIC* a la capacité d’intégrer des solutions tierces existantes :
- Gestionnaires de configuration de clouds *Ansible, Chef et Puppet* 
- Systèmes de surveillance *Zabbix, Centreon et PRTG*
- Authentification multi-facteurs (Google authenticator)
- Fédération d’identité SAML 2
- Authentification LDAP 
- Gestion d’adresses IP (IPAM)
- Pares-feu de sécurité

### Comptes, groupes et utilisateurs UIC
UIC utilise des notions et des termes qu’il convient de définir dans le contexte UIC, pour éviter au lecteur toute éventuelle ambiguité ou confusion dans la lecture de ce document et/ou dans l’usage du produit :

- **Compte** : Un compte (Account) décrit une organisation qui gère ou regroupe un ensemble de services qui seront déployés par UIC. Plusieurs comptes peuvent être créés, ils sont isolés les uns des autres. Chaque compte est associé à au moins un utilisateur doté des droits d’administration de ce compte.
- **Opérateur** : Le compte dit **’Opérateur’** est créé à l’installation de la plateforme. C’est un compte particulier et unique qui possède des droits d’administration privilégiés pour réaliser certaines actions ou tâches de gestion de la plateforme UIC. 
- **Utilisateur** : Les utilisateurs UIC sont de 4 types, Le tableau suivant dresse leurs dénominations ainsi que leurs descriptions :

Type d’utilisateur	|Description
--------------------|---------------
Administrateur de compte|	Un administrateur de compte possède par défaut tous les droits d’administration du compte
Utilisateur Régulier| 	Un utilisateur régulier possède des droits restreints qui peuvent être étendus à l’aide des rôles.
Administrateur API|	un utilisateur administrateur d’API peut utiliser l’API de UIC pour contrôler toutes les ressources déployées sur son compte.
Utilisateur API|	un utilisateur d’API n’a le contrôle que sur ses propres ressources.

- **Groupes** : Les groupes sont composés d’utilisateurs. Un groupe peut être associé à un ou plusieurs rôles, ce qui permet d’attribuer de façon globale des rôles aux utilisateurs.

- **Rôles** : Les rôles sont des droits supplémentaires attribués aux utilisateurs ou groupes, les rôles peuvent être cumulés. Les utilisateurs dans un groupe héritent des droits du groupe.

## Le portail web UIC
Le portail Web de la plateforme UIC est composé d’un tableau de bord développé à l’aide du framework php Laravel. Ce tableau de bord est accessible en HTTPS via un serveur web Apache2. Les données persistantes concernant les comptes, les identifiants Cloud, les utilisateurs et les groupes d’utilisateurs sont gérées par une base de données Mariadb. Les données concernant les ressources Cloud (fournisseurs, régions, gabarits de VMs, images de VMs, tarifs, etc.) sont programmées pour une mise à jour régulière à l’aide de l’ordonnanceur inclus dans le framework Laravel.

### Généralités

#### Répertoire d’installation 
L’IHM de la plateforme *Use IT Cloud* se trouve dans le dossier : 
```bash
/usr/share/uic-dashboard
```
#### Permissions sur les dossiers 
Le serveur Web utilisé par UIC est apache. Ce serveur doit accéder en mode écriture à la racine du répertoire /usr/share/uic-dashboard ainsi qu’aux sous-répertoires ci-dessous :
- storage
- vendor
- bootstrap/cache

Pour ce faire UIC positionne l’utilisateur www-data comme propriétaire de ces répertoires, à l’aide de la commande suivante :
```bash
sudo chown www-data:www-data /usr/share/uic-dashboard 
sudo chown -R www-data:www-data storage vendor bootstrap/cache
```
UIC positionne ensuite les permissions sur les dossiers à l’aide de la commande suivante :
```bash
sudo find /usr/share/uic-dashboard -type d -exec chmod 755 {} \;
```
Ces permissions sont positionnées automatiquement à l’installation de UIC.

#### Permissions sur les fichiers 
Seul le propriétaire d’un fichier a le droit d’écriture sur ce fichier. Les autres utilisateurs n’ont qu’un droit de lecture sur ce fichier. UIC utilise cette commande pour positionner ces permissions :
```bash
sudo find /usr/share/uic-dashboard -type f -exec chmod 644 {} \;
```
UIC positionne l’utilisateur www-data comme propriétaire du fichier /usr/share/uic-dashboard/.env à l’aide de la commande suivante :
```bash
sudo chown www-data:www-data /usr/share/uic-dashboard/.env
```
### Framework Laravel 
La partie IHM de la plateforme *UIC* est développée avec le Framework Laravel. Laravel fournit artisan comme interface de ligne de commandes. 

#### Commandes artisan
*UIC* fournit une liste de commandes artisan, elles sont nécessaires et utiles lors de l’exploitation de la plateforme. Cette liste est précisée dans le tableau suivant :

Commandes (CMD)	       |Résultat de la commande
-----------------------|------------------------
down | 	Place l’application en mode maintenance
up  |                       	Termine le mode maintenance de l’application
backup:clean  |         		Supprime les sauvegardes effectuées avant une certaine date (le nombre de jours est indiqué dans la configuration)
backup:list  |             		Affiche la liste des sauvegardes
backup:monitor  |           	Vérifie l’intégrité des sauvegardes
backup:run    |             	Effectue une sauvegarde.
log-viewer:stats  |         	Affiche les statistiques sur les logs
uic:create-account | 			Crée un compte dans la plateforme
uic:delete-account |         	Supprime un compte dans la base de données et/ou dans uic-core
uic:accounts-report |        	Génère un rapport sur les comptes, au format JSON ou CSV
uic:import-provider-image | 	Importe une image dans un compte
uic:update-public-cloud-data |	Met à  jour les images et/ou gabarits des Clouds publics
uic:list-applications  |      	Affiche la liste des applications du catalogue
uic:export-app  |             	Exporte une application du catalogue dans un fichier 
uic:import-app  |             	Importe une application dans le catalogue des applications
uic:delete-application  |     	Supprime une application du catalogue des applications

La syntaxe générale d’exploitation de ces commandes est détaillée ci-dessous. 

#### Syntaxe générale de la ligne de commandes artisan
La syntaxe générale pour exécuter une commande artisan est la suivante :
```bash
su - www-data -s /bin/bash -c "php /usr/share/uic-dashboard/artisan CMD"
````
où CMD représente la commande artisan à exécuter.
Exemple:
```bash
su - www-data -s /bin/bash -c "php /usr/share/uic-dashboard/artisan backup:list"
````
Cet exemple permet d’afficher la liste des sauvegardes effectuées par UIC.
Pour obtenir la syntaxe exacte d’une commande, ajouter l’argument help avant le nom de la commande, par exemple :
```bash
su - www-data -s /bin/bash -c "php /usr/share/uic-dashboard/artisan help uic:list-app"
````
Cette commande affichera la syntaxe de la commande uic:list-app.

### Configuration du portail
Le portail UIC nécessite une configuration globale de la plateforme et une configuration spécifique du service NodeJS (websockets) chargé de gérer les notifications temps réel avec les navigateurs web. 

#### Configuration globale
Les données de configuration globale du portail UIC sont contenus dans le fichier /usr/share/uic-dashboard/.env. C’est un fichier texte dont la structure est simple, chaque ligne contient une donnée sous forme de clé=valeur. Le tableau ci-dessous indique l’ensemble des clés configurables, leurs descriptions et leurs valeurs possibles. 
A chaque fois que le fichier de configuration .env est modifié, la commande suivante doit être exécutée pour prendre en compte les modifications.
```bash
su - www-data -s /bin/bash -c "php /usr/share/uic-dashboard/artisan horizon:terminate"
```
##### Fichier de configuration
Les paramètres qui permettent de configurer la plateforme UIC sont décrits dans le tableau ci-dessous : 

Variable	    | Valeur / explication
----------------|-----------------------------
APP_ENV	| local/production 
APP_DEBUG	| 	true/false
APP_KEY	| 	Clé qui permet de chiffrer/déchiffrer les données sensibles
APP_LOG	| 	"single" : un seul fichier de log, <br></br>"daily" : rotation journalière du fichier de log,<br></br> "syslog" : log redirigé dans le syslog, <br></br>"errorlog" : log redirigé dans le log d’erreur d’Apache
APP_LOG_LEVEL	| 	debug : degré de sévérité des logs
APP_URL		| https://www.exemple.org : URL de la plateforme
APP_DOMAIN	| 	Domaine de la plateforme, pour les redirections d’URL
DB_CONNECTION	| 	Base de données : par défaut mysql
DB_HOST	| 	Host de la base de données. Par défaut 127.0.0.1
DB_PORT	| 	Port de connexion à la base de données. Par défaut 3306.
DB_DATABASE	| 	uic : nom de la base de données
DB_USERNAME	| 	uic : utilisateur de la base de données
DB_PASSWORD	| Mot de passe de l’utilisateur uic pour la base de données
BROADCAST_DRIVER	| 	Redis, système pour websocket
CACHE_DRIVER	| 	Redis, système de cache
SESSION_DRIVER	| 	file/redis
QUEUE_DRIVER	| 	Redis, système de jobs (tâches en arrière-plan)
SOCKET_IO_HOST	| 	Host du server de websocket, par défaut self
SOCKET_IO_PORT	| 	443 : port d’écoute du serveur websocket
REDIS_HOST	| 	127.0.0.1 : hôte du serveur redis
REDIS_PASSWORD	| 	Mot de passe du serveur redis
REDIS_PORT	| 	6379 : Port du serveur redis
MAIL_DRIVER	| 	Smtp
MAIL_HOST	| 	Host du serveur smtp
MAIL_PORT	| 	Port smtp. Par défaut 2525
MAIL_USERNAME	| 	Utilisateur smtp
MAIL_PASSWORD	| 	Mot de passe utilisateur smtp
MAIL_ENCRYPTION		| Protocole de chiffrement : null/tls/ssl 
MAIL_FROM_ADDRESS	| 	Expéditeur des mails
MAIL_FROM_NAME	| 	Nom de l’expéditeur des mails
MAIL_OPERATOR	| 	Mail de l’opérateur de la plateforme : utiliser pour la création du premier utilisateur, et l’envoi de notifications
RESET_PASSWORD_TOKEN_EXPIRATION	| 	Délai d’expiration du jeton de mot de passe. Par défaut 60 minutes
QUEUE_PROCESSES_NOTIFICATIONS_EMAILS	| 	Nombre de processus pour gérer l'envoi des mails et des notifications, par défaut 3
QUEUE_PROCESSES_DEPLOYMENTS	| 	Nombre de processus pour suivre un déploiement, par défaut 5
QUEUE_PROCESSES_CLOUD	| 	Nombre de processus pour gérer les actions au niveau Cloud (Création de volume, arrêt de vApp, etc.), par défaut 10
QUEUE_PROCESSES_DEFAULT		| Nombre de processus gérant les autres tâches de fond, par défaut 2
BACKUP_ACTIVE	| 	Active (true) ou non (false) le lancement d’une sauvegarde automatique chaque nuit. Par défaut désactivé
ENABLE_GOOGLE_CHARTS	| 	Activer GOOGLE CHARTS (true/false)
ENABLE_LANGUAGE_PT	| 	Activer la version portugaise (true/false). Par défaut true. 
ENABLE_LANGUAGE_ES	| 	Activer la version espagnole (true/false). Par défaut true.
SITE_NAME	| 	Nom du site UIC. Par défaut « *Use IT Cloud* »
RECAPTCHA_PUBLIC_KEY	| 	Clé publique pour Google re-captcha
RECAPTCHA_PRIVATE_KEY	| 	Clé privée pour Google re-captcha
RECAPTCHA_ACTIVE	| 	false/true : activation ou non du captcha 
ACCOUNT_DEPLOYED_NODES_LIMIT	| 	Limite par défaut du nombre d'instances (null = aucune limite, 0 = interdit de déployer). Cette limite est fixée par défaut à chaque création d’un nouveau compte. Mais elle peut être ensuite modifiée pour chaque compte, via l’IHM de UIC.
UIC_CLOUD_DATA	| 	URL vers les fichiers json des flavors et images publiques des providers
ENABLE_CLOUD_DATA_AUTO_UPDATE	| 	false/true : activation ou non des mises à jour automatiques des images et flavors des clouds publics
ENABLE_REGISTRATION_ROUTES 	| 	activer ou non la possibilité de demander la création d'un compte
PASSWORD_EXPIRATION_DAYS	| 	Nombre de jours avant expiration des mots de passe, 0 = désactivé
PASSWORD_STRENGTH_MINIMUM_LENGTH_ENABLE		| Exiger un nombre minimum de caractères pour les mots de passe (true/false). Par défaut true.
PASSWORD_STRENGTH_MINIMUM_LENGTH_VALUE	| 	Nombre minimum de caractères pour les mots de passe. Par défaut 6.
PASSWORD_STRENGTH_MAXIMUM_LENGTH_ENABLE		| Exiger un nombre maximum de caractères pour les mots de passe (true/false). Par défaut false.
PASSWORD_STRENGTH_MAXIMUM_LENGTH_VALUE	| 	Nombre maximum de caractères pour les mots de passe. Par défaut 30.
PASSWORD_STRENGTH_MINIMUM_LOWERCASE_ENABLE	| 	Exiger un nombre minimum de caractères minuscules pour les mots de passe (true/false). Par défaut false.
PASSWORD_STRENGTH_MINIMUM_LOWERCASE_VALUE	| 	Nombre minimum de caractères minuscules pour les mots de passe. Par défaut 1.
PASSWORD_STRENGTH_MINIMUM_UPPERCASE_ENABLE	| 	Exiger un nombre minimum de caractères majuscules pour les mots de passe (true/false). Par défaut false.
PASSWORD_STRENGTH_MINIMUM_UPPERCASE_VALUE	| 	Nombre minimum de caractères majuscules pour les mots de passe. Par défaut 1.
PASSWORD_STRENGTH_MINIMUM_DIGIT_ENABLE	| 	Exiger un nombre minimum de chiffres pour les mots de passe (true/false). Par défaut false.
PASSWORD_STRENGTH_MINIMUM_DIGIT_VALUE	| 	Nombre minimum de chiffres pour les mots de passe. Par défaut 1.
PASSWORD_STRENGTH_MINIMUM_SPECIAL_CHARACTER_<br></br>_ENABLE	| 	Exiger un nombre minimum de caractères spéciaux pour les mots de passe (true/false). Par défaut false.
PASSWORD_STRENGTH_MINIMUM_SPECIAL_CHARACTER_<br></br>_VALUE	| 	Nombre minimum de caractères spéciaux pour les mots de passe. Par défaut 1.
PASSWORD_STRENGTH_MINIMUM_DIFF_CHARACTERS_<br></br>_ENABLE	| 	Exiger un nombre minimum de caractères différents pour les mots de passe (true/false). Par défaut false.
PASSWORD_STRENGTH_MINIMUM_DIFF_CHARACTERS _<br></br>_VALUE	| 	Nombre minimum de caractères différents pour les mots de passe. Par défaut 2.
PASSWORD_STRENGTH_MINIMUM_DIFF_CHARACTERS_WITH_<br></br>_OLD_PASSWORD_ENABLE	| 	Exiger un nombre minimum de caractères différents du précédent mot de passe (true/false). Par défaut false.
PASSWORD_STRENGTH_MINIMUM_DIFF_CHARACTERS_WITH_<br></br>_OLD_PASSWORD_VALUE	| 	Nombre minimum de caractères différents du précédent mot de passe. Par défaut 1.
VISIBLE_IP_FROM_PUBLIC_CLOUD	| 	IP de la plateforme visible par les Clouds publics
UIC_CORE_PUBLISHER	| 	Adresse du service PUBLISHER de UIC. Par défaut https://127.0.0.1:8086
UIC_CORE_USER	| 	uic@useitcloud.com
UIC_CORE_PASSWORD	| 	Mot de passe de uic-core créé lors de l’installation
ENABLE_UIC_CORE_GET_LOGS	| 	false/true : tracer toutes les requêtes GET internes, par défaut false
PROXY	| 	URL : Configuration de plateforme derrière un proxy
FACEBOOK_ID		| Identifiant Facebook pour l’authentification OAuth2
FACEBOOK_SECRET	| 	Clé de connexion Facebook
GOOGLE_ID	| 	Identifiant Google pour l’authentification OAuth2
GOOGLE_SECRET	| 	Clé de connexion Google
TWITTER_ID	| 	Identifiant Twitter pour l’authentification OAuth2
TWITTER_SECRET	| 	Clé de connexion Twitter
LINKEDIN_ID		| Identifiant LinkedIn pour l’authentification OAuth2
LINKEDIN_SECRET		| Clé de LinkedIn twitter
GITHUB_ID	| 	Identifiant GitHub pour l’authentification OAuth2
GITHUB_SECRET	| 	Clé de connexion GitHub
UIC_CORE_SERVICE_CHECK_CRON		| Format crontab, permet de faire un check « exists » dans le log pour identifier des M avec l’interval un  ```0 0 1 * * : le premier jour du mois```
LICENSE_MANAGER_URL		| URL du gestionnaire de licences
PROVIDER_NAME_VCLOUD	| 	Attribuer un nom au fournisseur vCloud
PROVIDER_NAME_VSPHERE	| 	Attribuer un nom au fournisseur vSphere
PROVIDER_NAME_OPENSTACK		| Attribuer un nom au fournisseur Openstack
PROVIDER_NAME_FLEXIBLE_ENGINE	| 	Attribuer un nom au fournisseur Flexible Engine
BILLING_MODE	| 	Activer/désactiver le mode *billing* à la plateforme. Les valeurs possibles sont true ou false

##### Mode de fonctionnement de la plateforme
La plateforme UIC peut fonctionner selon deux modes :
- Un mode où seules les fonctionnalités financières sont activées. Dans ce mode les utilisateurs auront accès uniquement aux fonctions inhérentes aux factures, aux budgets et aux consommations. Pour activer ce mode, utilisez le paramètre BILLING_MODE=true dans le fichier de configuration globale /usr/share/uic-dashboard/.env. Les menus de  la plateforme seront alors conformes à la fenêtre suivante:

![Image](/img_fr/img_UIC_Guide_Exploitation/image003.png#bordered)

- Un mode où toutes les fonctionnalités supportées par UIC sont activées. Vous pouvez activer ce mode soit en précisant le paramètre BILLING_MODE=false dans le fichier de configuration globale /usr/share/uic-dashboard/.env, soit en supprimant ce paramètre du fichier.

##### Personnalisation des noms des Clouds
La plateforme UIC vous permet de renommer certains Clouds à l’aide de paramètres spécifiques à inclure dans le fichier de configuration globale /usr/share/uic-dashboard/.env. Voici la liste de ces paramètres :

Paramètre	        | Description
--------------------|-------------------
PROVIDER_NAME_VCLOUD |	Attribuer un nom au Cloud vCloud, le nom par défaut est vCloud 
PROVIDER_NAME_VSPHERE |		Attribuer un nom au Cloud vSphere, le nom par défaut est vSphere
PROVIDER_NAME_OPENSTACK |		Attribuer un nom au Cloud Openstack, le nom par défaut est OpenStack
PROVIDER_NAME_FLEXIBLE_ENGINE |		Attribuer un nom au Cloud Flexible Engine, le nom par défaut est Flexible Engine

A titre d’exemple si vous disposez d’un cloud privé géré sous VMware vCloud, que vous mettez à disposition de vos clients et que vous souhaitez que ce Cloud porte le nom de votre société vous pouvez ajouter le paramètre ```POVIDER_NAME_VCLOUD=MA_SOCIETE``` dans le fichier de configuration. Le nom ‘MA_SOCIETE’ apparaîtra à la place du nom par défaut ‘vCloud’ dans l’IHM de UIC. 

##### Gestion des Licences
L’utilisation de la plateforme UIC en mode hébergée est soumise à Licence. Le gestionnaire des licences est un service dont il faut préciser l’adresse dans le fichier de configuration. Le paramètre qui permet de spécifier cette adresse est nommé **LICENSE_MANAGER_URL**. A titre d’exemple ```LICENSE_MANAGER_URL= ‘’https://licenses.useitcloud.com/licenses/new’’```.

### Serveur web
Use IT Cloud utilise le serveur http Apache 2.4.18 avec PHP 7.1.
Tous les fichiers de configuration de Apache2 sont dans le dossier **/etc/apache2**. Ce dossier est composé des fichiers et dossiers suivants : 
```bash
apache2.conf  conf.d  envvars  httpd.conf  mods-available  mods-enabled  ports.conf  sites-available  sites-enabled
```
- **envvars** est utilisé pour définir des variables d'environnement propres à Apache,
- **ports.conf** contient la directive listen qui spécifie les adresses et les ports d'écoutes
- **apache2.conf** est le fichier principal de configuration, c'est à partir de lui que tous les autres fichiers sont chargés
- **sites-available** contient les fichiers de configuration des sites disponibles
- **sites-enabled** contient des liens symboliques vers les configurations, dans sites-available, des sites activés
- **conf-available** contient les fichiers de configuration des autres services disponibles
- **conf-enabled** contient des liens symboliques vers les configurations, dans conf-available, des autres services activés
- **mods-available** contient les fichiers de configuration des modules d'Apache disponibles
- **mods-enabled** contient des liens symboliques vers les configurations, dans mods-available, des modules activés 

#### Configuration du serveur
La configuration du serveur se trouve dans le ficher suivant : 
```/etc/apache2/apache2.conf```
Ce fichier contient des instructions qui permettent de déplacer certaines parties de la configuration dans d'autres fichiers. Ubuntu utilise cette fonctionnalité pour les modules (comme PHP) et la gestion des serveurs virtuels.

##### Configuration des modules
Le répertoire ```/etc/apache2/mods-enabled``` contient les modules activés. Les modules activés sont des liens symboliques vers les modules installés. Pour activer ou désactiver un module, on peut manipuler directement les liens ou utiliser les commandes a2enmod et a2dismod
**Modules activés pour UIC** 
Pour afficher la liste des modules Apache, nous allons utiliser la commande apache2ctl. 
```bash
 apache2ctl -t -D DUMP_MODULES
 ```
Les modules Apache à activer pour le bon fonctionnement de *Use IT Cloud* sont les suivants : 
- **rewrite** : Ce module est obligatoire pour le bon fonctionnement des URL UIC. Ce module fournit un moteur de réécriture à base de règles permettant de réécrire les URL des requêtes à la volée. 
- **proxy, proxy_http** : ces deux modules sont nécessaires pour le bon fonctionnement de la console shell web fournie par UIC. 
- **ssl** : Ce module fournit le support SSL v3 et TLS v1 au serveur HTTP Apache. 
- **headers** : ce module permet la personnalisation des en-têtes de requêtes et de réponses http. Nous l’activons dans UIC pour sécuriser les cookies (instructions Secure et HttpOnly).
- **proxy_wstunnel** : ce module fournit le support du tunnelling pour les connexions websockets vers un serveur websockets d'arrière-plan.

##### Configuration des sites
Le répertoire ```/etc/apache2/sites-available``` contient la liste des sites web disponibles et le répertoire ```/etc/apache2/sites-enabled``` contient la liste des sites activés. 
Les sites peuvent être activés ou désactivés en manipulant les liens dans sites-enabled ou en utilisant a2ensite et a2dissite

##### Serveurs virtuels (virtual hosts)
Le site par défaut de la plateforme *Use IT Cloud* est : uic-ssl.conf 
Voici ce que vous devez trouver au minimum dans le fichier 
```/etc/apache2/site-available/uic-ssl.conf```
(les commentaires et/ou explications éventuels(les) précèdent les directives)
```py
<VirtualHost *:443>

# ServerName définit le nom utilisé pour le vhost. Mettez le nom de l'hôte du domaine
ServerName demo.useitcloud.com

# DocumentRoot définit le dossier racine dans lequel seront stockés 
# les fichiers publics du site
DocumentRoot /usr/share/uic-dashboard/public

# Directory définit les options par défaut du répertoire
<Directory /usr/share/uic-dashboard/public>

# La directive Allowoverride est utilisée pour permettre l'utilisation du .htaccess 
Allowoverride All

# aucune adresse IP bloquée pour accéder au service
	Require all granted
</Directory>

#Forcer le HSTS (HTTP Strict Transport Security) pour les connexions avec les #navigateurs, appliquer au domaine racine et les sous-domaines. 

Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains; preload"

#Les directives pour les certificats
#Activation SSL pour ce hôte virtuel.
#Cette directive permet d'activer le moteur SSL au sein d'un hôte virtuel, 
#Elle peut prendre deux arguments –> on/off

SSLEngine On

#Exclure les protocoles et les versions SSL/TLS indiqués
SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1

#L'ordre des procédés de chiffrements dans SSLCipherSuite doit être respecté. La #première correspondance trouvée doit être utilisée

SSLHonorCipherOrder on

# Pas de compression SSL
SSLCompression off

#Exclure les algorithmes de chiffrement indiqués pour la négociation au cours de #l'initialisation de la connexion SSL

SSLCipherSuite HIGH:!aNULL:!MD5:!3DES

#SSLCertificateFile 
#Cette directive définit le certificat authentifiant le Serveur auprès des clients. 
#L'argument est le chemin d'accès au certificat. 

SSLCertificateFile      /etc/letsencrypt/live/demo.useitcloud.com/fullchain.pem

#SSLCertificateKeyFile
#Cette directive définit la clé privée du Serveur utilisée pour signer l'échange de clé entre le client et le serveur. 
#Elle prend en argument le chemin d'accès à la clé (fichier)

SSLCertificateKeyFile /etc/letsencrypt/live/demo.useitcloud.com/privkey.pem

#Utiliser apache comme proxy pour le serveur websocket « laravel-echo-server » #(socket.io, port 6001). On aura un seul port d’écoute externe qui est le 443.

RewriteEngine On
RewriteCond %{REQUEST_URI}  ^/socket.io            [NC]
RewriteCond %{QUERY_STRING} transport=websocket    [NC]
RewriteRule /(.*)           ws://localhost:6001/$1 [P,L]
ProxyPass        /socket.io http://localhost:6001/socket.io
ProxyPassReverse /socket.io http://localhost:6001/socket.io

</VirtualHost>
```
Pour tester l'ensemble de la configuration d'Apache :
```bash
sudo apache2ctl -t
```
Pour tester la configuration des hôtes virtuels :
```bash
sudo apache2ctl -t -D DUMP_VHOSTS
```
![Image](/img_fr/img_UIC_Guide_Exploitation/image004.png#bordered)

Pour voir les modules d'Apache chargés :
```bash
sudo apache2ctl -M
```
#### Administration de Apache2
Lorsque des modifications de configuration sont apportées au service web, leur prise en compte nécessite de recharger le service. La commande suivante permet de redémarrer Apache2 :
```bash
sudo /etc/init.d/apache2 restart  
sudo service apache2 restart
sudo systemctl restart apache2
```
Il est aussi possible de redémarrer le service en douceur, sans "tuer" les requêtes en cours. 
```bash
apache2ctl graceful
```
Lors d’un redémarrage d’un serveur en production, cette commande est plus appropriée.

### Service web SSH pour les accès aux machines virtuelles Linux 
Use IT Cloud intègre un service ssh web-based (Shell in a box), celui-ci permet d’émuler un terminal ssh basé sur une page web accédant aux machines virtuelles Linux. Par défaut, huit sessions simultanées sont configurées à l’installation de la plateforme UIC. Par défaut, les ports d’écoute sont compris entre 4200 et 4207. 
Le changement ou la modification d’un port nécessite une vérification, contrôlez que le port n’est pas déjà utilisé par un autre service ou une autre application. La commande suivante devrait suffire :
```bash
 netstat -aulptn | grep votre_port
``` 
Il faut modifier la configuration de shellinabox dans les fichiers ci-dessous pour changer le nombre de sessions :

```/etc/apache2/mods-available/proxy.conf```

```php
<IfModule mod_proxy.c>
	##Session 1
	<Location /shellbox-4200/ >
	   proxyPass http://localhost:4200/
	   Order allow,deny
	   Allow from all
	   SetEnv proxy-nokeepalive 1
	</Location>
…
	##Session 8
	<Location /shellbox-4207/ >
	   proxyPass http://localhost:4207/
	   Order allow,deny
	   Allow from all
	   SetEnv proxy-nokeepalive 1
	</Location>
</IfModule>
````
```/usr/share/uic-dashboard/resources/scripts/shellinabox.sh```
- Changez le paramètre : --cgi=4200-4207 
Le redémarrage du service shellinabox et du serveur Apache sont nécessaires.

Rappel des commandes principales :
```bash
service shellinabox status : vérifie le statut du service shellinabox
service shellinabox restart : redémarrage du service shellinabox
service shellinabox stop : arrêt du service shellinabox
service shellinabox start : démarrage du service shellinabox
```

### Serveur NodeJS
*Laravel-echo-server* est un serveur NodeJS basé sur Socket.io, il permet la communication avec un navigateur à travers le protocole WebSocket. Il permet à la plateforme *Use IT Cloud* d'afficher des informations en temps réel. Le serveur Node.js écoute les requêtes sur un port spécifique du serveur sur lequel il est lancé.<br></br>
Pour faire fonctionner laravel-echo-server sur le même port que le portail *Use IT Cloud*, la méthode choisie consiste en une utilisation du proxy inverse d’Apache (reverse proxy) qui permet de rediriger les requêtes du client vers un autre serveur en fonction de l’URL de la requête entrante.<br></br>
Avec cette approche, nous pouvons configurer laravel-echo-server pour qu’il n’écoute que sur localhost, dans cet exemple, le port 6001. Lorsque vous lancez votre navigateur, une connexion websocket sera reçue et analysée sur le même hôte et le même port que l’application qui est en cours d'exécution, puis transmise en interne par apache à laravel-echo-server.
Pour fonctionner nous devons activer les modules apache proxy_http et proxy_wstunnel.<br></br>
Ces mécanismes sont décrits dans les sections suivantes. 

#### Configuration de NodeJS
Le fichier laravel-echo-server.json contient la configuration du serveur NodeJS (pour les WebSockets). <br></br>
La configuration de ce serveur se fait à travers le fichier ci-dessous : 

```/usr/share/uic-dashboard/laravel-echo-server.json```
![Image](/img_fr/img_UIC_Guide_Exploitation/image005.png#bordered)

Clé	              | Description
------------------|-------------------
authHost | 	L'hôte du serveur qui authentifie les canaux privés et de présence
authEndpoint | 	La route qui authentifie les canaux privés
database | 	Base de données utilisée pour stocker les données qui devraient persister, comme les membres du canal de présence. Les options sont actuellement redis et sqlite.
Host | 	localhost : accepte les connexion uniquement en local<br></br>null : acceptera les connexions sur n'importe quelle adresse IP
Port | 	6001 : Le port sur lequel le serveur socket.io doit écouter
Protocol | 	Doit être http ou https
sslCertPath | 	Le chemin d'accès au certificat SSL de votre serveur
sslKeyPath | 	Le chemin vers la clé SSL de votre serveur
sslCertChainPath | 	Le chemin vers la chaîne de certificats SSL de votre serveur
sslPassphrase | 	La phrase de passe à utiliser pour le certificat (le cas échéant)
devMode | 	True/false : journalisation supplémentaire à des fins de développement

Le serveur est automatiquement lancé au démarrage de la plateforme.
Pour l'arrêter/démarrer ou redémarrer : 
```bash
sudo supervisorctl stop uic-ws:*
sudo supervisorctl start uic-ws:*
sudo supervisorctl restart uic-ws:*
```
#### Utilisation de Apache comme proxy inverse websocket
Dorénavant, UIC configure automatiquement apache pour servir comme proxy pour les accès https au serveur laravel-echo-server. Cette configuration est prise en compte dans le fichier ```/etc/apache2/sites-available/uic-ssl.conf``` dont le contenu est décrit dans la section Serveurs virtuels (virtual hosts) incluse dans ce document.<br></br>
Si vous disposez d’une ancienne version de UIC et que vous souhaitez mettre en place ce mécanisme, vous pouvez procéder comme ceci :
- Rajoutez les paramètres suivants dans le fichier :
```
/etc/apache2/sites-available/uic-ssl.conf 
```
```yaml
#Paramètres de renforcement de la sécurité concernant ssl/tls
SSLEngine on
SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
SSLHonorCipherOrder on
SSLCompression off
SSLCipherSuite HIGH:!aNULL:!MD5:!3DES
SSLOptions +StrictRequire
#Paramètres concernant la redirection websocket
RewriteEngine On
RewriteCond %{REQUEST_URI}  ^/socket.io            [NC]
RewriteCond %{QUERY_STRING} transport=websocket    [NC]
RewriteRule /(.*)           ws://localhost:6001/$1 [P,L]
ProxyPass        /socket.io http://localhost:6001/socket.io
ProxyPassReverse /socket.io http://localhost:6001/socket.io
```
- Ajoutez la ligne suivante dans le fichier /usr/share/uic-dashboard/.env :
```bash
SOCKET_IO_PORT=443
```
- Activez le module wstunnel et redémarrez apache
```bash
a2enmod proxy_wstunnel
service apache2 restart
```
- Redémarrez le service websocket à l’aide de la commande suivante :
```bash
supervisorctl restart uic-ws:*
```
### Gestion des tâches d’arrière-plan

#### File d'attente pour les tâches d’arrière-plan
La mise en place d'un système de file d'attente permet de déléguer une partie des traitements à un processus séparé et ainsi d'améliorer les performances de l'application. La gestion des files d'attente avec Laravel fournit une API unifiée sur différents backends, tels que Beanstalk, Amazon SQS, Redis ou même une base de données relationnelle. <br></br>
Le fichier de configuration de la file d'attente est stocké dans :

```/usr/share/uic-dashboard/config/queue.php```

Dans ce fichier, vous trouverez les configurations de connexion pour chacun des pilotes de file d'attente inclus dans le framework. *Use IT Cloud* utilise le pilote Redis, la configuration se fait en spécifiant redis dans la variable QUEUE_DRIVER du fichier .env

#### Les jobs
Certaines actions sont exécutées sous forme de "Job", des tâches consommatrices en temps, exécutées en arrière plan pour permettre à l'application de répondre le plus rapidement possible aux requêtes client (Exemples : envois de mail, envois de notification, déploiements, arrêt d’une instance)<br></br>
L'outil *Supervisor* permet de lancer des processus en attente de job à exécuter, et de redémarrer automatiquement ces processus s'ils s’arrêtent.<br></br>
Par défaut, 5 processus s'occupent des jobs de suivi de déploiements, 3 pour les envois de notifications et mails, 10 pour les actions sur les fournisseurs de Cloud, 2 pour des tâches variées. Le nombre de processus se configure dans le fichier .env.

#### Laravel Horizon
*Laravel Horizon* est un outil pour l’opérateur permettant de surveiller l’activité des jobs. Il permet de voir le nombre de processus par queue, le nombre de jobs en attente d’exécution, le nombre de jobs échoués afin de pouvoir les relancer.<br></br>
L’outil Supervisor permet de lancer Laravel Horizon et de le redémarrer automatiquement en cas d’arrêt.<br></br>
Le fichier de configuration pour Supervisor se trouve dans :
```bash
/etc/supervisor/conf.d/uic-horizon.conf
[program:uic-horizon]
process_name=%(program_name)s
command=php /usr/share/uic-dashboard/artisan horizon
autostart=true
autorestart=true
user=www-data
redirect_stderr=true
stdout_logfile=/usr/share/uic-dashboard/storage/logs/horizon.log
```
Le fichier de configuration de Laravel Horizon se trouve dans le répertoire suivant : 

```/usr/share/uic-dashboard/config/horizon.php```

En mode production, le nombre de processus par queue se configure dans le fichier .env

Variable	                         | Explication	| Valeur par défaut
-------------------------------------|--------------|:---------------------:
QUEUE_PROCESSES_NOTIFICATIONS_EMAILS |	Nombre de processus pour gérer l'envoi des mails et des notifications |	3
QUEUE_PROCESSES_DEPLOYMENTS	|Nombre de processus pour suivre un déploiement	|5
QUEUE_PROCESSES_CLOUD|	Nombre de processus pour gérer les actions au niveau Cloud (Création de volume, arrêt de vApp, etc.)	|10
QUEUE_PROCESSES_DEFAULT	|Nombre de processus gérant les autres tâches de fond	|2
 
Commandes : 
```bash
php /usr/share/uic-dashboard/artisan horizon:terminate
```
Cette commande (à exécuter en tant que root ou www-data) termine proprement *Horizon*, après que les processus aient fini leurs tâches en cours. *Supervisor* s'occupe de redémarrer Horizon ainsi que les processus. Cette commande est nécessaire pour permettre aux processus de prendre en compte les changements de configuration ou de code source.

#### Les crons lancés dans UIC
*Use IT Cloud* exécute certaines tâches à différents moments de la journée (cron).<br></br>
Si **ENABLE_CLOUD_DATA_AUTO_UPDATE** a l’état « true » dans le fichier .env, deux fois par jour (4h00 et 14h00), la plateforme met à jour sa base de gabarits et d’images des clouds publics. <br></br>
Si **BACKUP_ACTIVE** a l’état « true » dans le fichier .env, elle exécutera une sauvegarde la nuit. (Sauvegarde à 2h00, suppression des plus anciennes sauvegardes à 2h30, vérification de l'état des sauvegardes à 3h00).

### Les SGBD du portail UIC
UIC utilise deux SGBD ayant chacun un rôle spécifique :
- Redis, pour la gestion du cache des pages des transactions et des données volatiles,
- Mariadb, pour les données persistantes.

#### Le SGBD MariaDB
La version installée est MariaDB 10.3.<br></br>
Le nom de la base de données utilisée par *Use IT Cloud* est « uic », elle est créée avec l’utilisateur « uic ».<br></br>
***Commandes utiles***<br></br>
```bash
sudo systemctl status mysql: voir l’état du serveur mysql
sudo systemctl start mariadb : démarrer le serveur mysql
sudo systemctl stop mysql : arrêter le serveur mysql 
```
***Fichiers et dossiers associés***<br></br>
```bash
/etc/mysql/conf.d/ : 	Le dossier contenant les fichiers de configuration
/var/lib/mysql/ :	Le dossier contenant les données du serveur (les bases de données) 
```
***Sauvegarde de la base de données, à froid***<br></br>
Lorsque le service est arrêté, il suffit de sauvegarder le dossier ```/var/lib/mysql/```. Cette solution est effectivement la plus simple mais elle nécessite l'arrêt du service.

***Sauvegarde de la base de données, à chaud***<br></br>
Il s'agit d'utiliser la commande mysqldump pour réaliser une sauvegarde sans arrêter le service. La syntaxe générale de cette commande est la suivante :
```bash
mysqldump -u user -p[user_password] [database_name] | gzip > dumpfilename.sql.gz
```
Pour sauvegarder la base de données de *Use IT Cloud*, il faut utiliser la commande suivante :
```bash
mysqldump -u uic -p[user_password] uic | gzip > dumpfilename.sql.gz
```

#### Le SGBD Redis
Le portail UIC utilise le SGBD Redis pour stocker les données pouvant être consultées fréquemment. Ces données sont sauvegardées dans l’index 15 de la table Redis.<br></br>
L’installation, la configuration et l’utilisation du SGBD Redis sont décrites en détails dans le chapitre Service uic-core de ce document. 

### Gestion des données 
#### Mise à jour des images et des gabarits des clouds publics
La mise à jour des images et des gabarits de tous les Clouds publics gérés par UIC  peut être effectuée à l’aide de la commande artisan suivante :
```bash
su - www-data -s /bin/bash -c "php /usr/share/uic-dashboard/artisan  uic:update-public-cloud-data"
```
Mise à jour des images et des gabarits pour un seul fournisseur :
```bash
su - www-data -s /bin/bash -c "php /usr/share/uic-dashboard/artisan uic:update-public-cloud-data <NomDuFournisseur>” 
````
où ```<NomDuFournisseur>``` peut prendre une des valeurs suivantes : amazonaws, cloudwatt, flexibleengine, googlecloud, microsoftazure ou ovh.

Par exemple, pour mettre à jour des images et des gabarits du Cloud Amazon AWS :
```bash
su - www-data -s /bin/bash -c "php /usr/share/uic-dashboard/artisan uic:update-public-cloud-data amazonaws” 
```
Mise à jour avec les options --flavors et --images pour ne mettre à jour que les gabarits ou les images
```bash
su - www-data -s /bin/bash -c "php /usr/share/uic-dashboard/artisan uic:update-public-cloud-data amazonaws –flavors"
su - www-data -s /bin/bash -c "php /usr/share/uic-dashboard/artisan uic:update-public-cloud-data amazonaws –images"
```
#### Gestion des catégories d’applications
La gestion des catégories des applications est réalisable à l’aide des menus du portail web de UIC. Cette gestion est détaillée dans le document intitulé ‘’UiC_Guide_UserAdmin’’.

#### Gestion des applications 
UIC fournit les commandes ci-dessous pour gérer les applications en ligne de commande.

##### Import et export d’application 
L’export d’applications dans UIC peut se faire soit en ligne de commande, soit directement à travers le Dashboard. L’import se fait uniquement en ligne de commande.
- Exportez une application de la base UIC dans le dossier storage/app/exported_applications 
```bash
su - www-data -s /bin/bash -c "php /usr/share/uic-dashboard/artisan uic:export-app [application_id]”
```
application_id est l’identifiant de l’application à exporter.
- Importez une application dans la base
```bash
su - www-data -s /bin/bash -c "php /usr/share/uic-dashboard/artisan uic:import-app [path_to_zip_file]" 
```
path_to_zip_file est le chemin d’accès du fichier zip à importer.

##### Liste des applications
La commande suivante permet de lister les applications disponibles :
```bash
su - www-data -s /bin/bash -c "php /usr/share/uic-dashboard/artisan uic:list-applications"
```
![Image](/img_fr/img_UIC_Guide_Exploitation/image006.png#bordered)

En sortie standard de cette commande, UIC affiche pour chaque application du catalogue, les paramètres suivants :

Paramètre	    | Description
----------------|--------------------------------------------
ID	 			| Identifiant numérique de l’application configurée
UUID	 		| UUID de l’application configurée
From application| En cas d'import, UUID de l’application origine 
Name	 		| Nom de l’application
Number of nodes	| Le nombre de VMs qui composent l’application
Status	 		| La catégorie de l’application (Public ou Private)
Account name 	| Le nom du compte dans lequel se trouve l’application privée
 
##### Suppression d’application
Afin de supprimer une application dans le catalogue de UIC, il faut récupérer l’ID ou l’UUID de l’application à supprimer. La commande suivante permet de supprimer une application du catalogue : 
```bash
su - www-data -s /bin/bash -c "php /usr/share/uic-dashboard/artisan uic:delete-application [ID ou UUID] --force"
```

#### Gestion des comptes et des utilisateurs

##### Liste des commandes artisan
UIC fournit une liste de commandes artisan qui permettent de gérer les comptes :

Commande artisan	 | Description
---------------------|--------------------------
uic:create-account 	 | Permet de créer un compte
uic:delete-account 	 | Permet de supprimer un compte
uic:accounts-report  | Permet de générer un rapport des comptes aux formats JSON ou CSV

##### Création d’un compte
La commande artisan qui permet de créer un compte est uic:create-account. La syntaxe générale de cette commande est la suivante :
```bash
uic:create-account [--][options]  [<account> [<user> [<email> [<password>]]]]
````
Voici le tableau indiquant les principaux arguments de cette commande :
```bash
Arguments:
  account               	Nom du compte
  user                  	Nom de l'utilisateur
  email                 	Email de l'utilisateur
  password              	Mot de passe de l'utilisateur

Options	--operator        	Si l'utilisateur à créer est un opérateur
	--force-create    	Pour ne pas demander la confirmation de la création
	--user-only        	Pour ne créer que l'utilisateur si le compte existe déjà
	--admin           	A combiner avec --user-only, si l'utilisateur à créer est un administrateur du compte
````
Exemple de commande :
```bash
su - www-data -s /bin/bash -c "php /usr/share/uic-dashboard/artisan uic:create-account bigcompany admin1@bigcompany.fr secretpassword --force-create"
```
Cette commande permet de forcer la création d’un compte nommé *bigcompany*, avec *admin1* comme administrateur de compte, *secretpassword* comme mot de passe.

##### Suppression d’un compte
La commande artisan qui permet de supprimer un compte est **uic:delete-account**. La syntaxe générale de cette commande est la suivante :
```bash
uic:delete-account [<account>]
```
##### Génération de rapports sur les comptes
La commande artisan qui permet de générer un rapport sur les comptes UIC  uic:accounts-report. La syntaxe générale de cette commande est la suivante :
```bash
uic:accounts-report -–format=[json,csv]
```
Cette commande permet de générer les rapports sur les comptes d’une plateforme UIC. Deux formats de rapports sont possibles, JSON ou CSV. Si le format n’est pas spécifié, c’est le format JSON qui sera employé. Voici la liste des données contenues dans ce rapport :

Paramètre	        | Description
--------------------|------------------------
Id					|  Identifiant numérique du compte
Name 				| 	Nom du compte
Nature 				| 	Nature du compte
State 				| 	Etat du compte
total_deployed_nodes| 	Nombre total de noeuds déployés
deployed_nodes_limit| 	Limite d’instances
created_at 			| 	Date de creation
nb_users 			| 	Nombre d’utilisateurs
nb_admin_users  	| 	Nombre d’administrateurs

Voici un exemple de rapport généré par cette commande :  
```json
[{"id":1,"name":"prologue","nature":"operator","state":"Active","total_deployed_nodes":10,"deployed_nodes_limit":null,"created_at":"2019-07-02 16:44:10","nb_users":1,"nb_admin_users":1},{"id":2,"name":"c1","nature":"client","state":"Active","total_deployed_nodes":6,"deployed_nodes_limit":null,"created_at":"2019-07-02 16:51:18","nb_users":8,"nb_admin_users":2},{"id":3,"name":"c2","nature":"client","state":"Active","total_deployed_nodes":0,"deployed_nodes_limit":null,"created_at":"2019-07-02 16:51:22","nb_users":8,"nb_admin_users":2},{"id":4,"name":"c3","nature":"client","state":"Active","total_deployed_nodes":0,"deployed_nodes_limit":null,"created_at":"2019-07-02 16:51:25","nb_users":8,"nb_admin_users":2},{"id":5,"name":"c4","nature":"client","state":"Active","total_deployed_nodes":0,"deployed_nodes_limit":null,"created_at":"2019-07-02 16:51:28","nb_users":8,"nb_admin_users":2}]
```
Dans cet exemple, le rapport généré contient des données concernant les cinq comptes prologue, c1, c2, c3 et c4.

##### Gestion des utilisateurs
 La commande artisan qui permet de créer un utilisateur attaché à un compte est **uic:create-account**, en spécifiant l’option **–user-only**. La syntaxe générale de cette commande est la suivante :
```bash 
uic:create-account [options] -–user-only [<account> [<user> [<email> [<password>]]]]
```
La commande qui permet de créer un utilisateur ayant les droits d’administration d’un compte, il faut spécifier l’argument ‘’**–admin**’’ comme paramètre. La commande devient alors :
```bash
uic:create-account [options] -–user-only -–admin [<account> [<user> [<email> [<password>]]]]
```
##### Gestion des rôles
La gestion des rôles UIC est réalisable à l’aide des menus du portail web de UIC. Cette gestion est détaillée dans le document intitulé ‘’UiC_Guide_UserAdmin’’.

#### Intégration avec les outils IT tiers
UIC intègre l’interfaçage avec certains outils IT tiers tels que :
- les annuaires LDAP,
- les services SSO basés sur SAML, 
- les gestionnaires de configuration comme Ansible, Chef et Puppet,
- Les outils de monitoring comme Zabbix, Centreon,
- Les services d’authentification 2 facteurs comme Google Authenticator.
La configuration et la mise en œuvre de ces interfaces s’effectuent à l’aide des menus et commandes de l’IHM. Vous trouverez tous les détails sur ces points dans le document intitulé ‘’UiC_Guide_UserAdmin’’ qui accompagne le produit UIC. 

### Gestion des Logs 
#### Logs Apache2 
**Journal des erreurs** : Dans ce journal le démon Apache httpd envoie les informations de diagnostic et enregistre toutes les erreurs qui surviennent lors du traitement des requêtes. Le nom et la localisation sont définis par la directive ErrorLog. Sur la plateforme UIC, ils sont définis dans le répertoire suivant : 
```bash
/var/log/apache2/error.log
```
**Journal des accès** : Le journal des accès au serveur enregistre toutes les requêtes que traite ce dernier. La localisation et le contenu du journal des accès sont définis par la directive CustomLog. En ce qui concerne la plateforme UIC, ils sont définis dans le fichier suivant :
```bash
/var/log/apache2/access.log
```

#### Logs du portail (Laravel)
Laravel fournit une couche d'abstraction simple au-dessus de la puissante bibliothèque Monolog. Par défaut, Laravel est configuré pour créer un fichier journal de la plateforme UIC dans le répertoire : 
```bash
/usr/share/uic-dashboard/storage/logs/
```
UIC est configuré pour avoir une rotation journalière du fichier de log.
```bash
/usr/share/uic-dashboard/storage/logs/laravel-aaaa-mm-dd.log
```

## Service uic-core
Le bloc appelé uic-core est composé de plusieurs micro-services spécialisés chacun dans une fonction déterminée. Ce bloc utilise des fichiers pour la partie configuration des micro-services et une base de données Redis pour la partie gestion des données de fonctionnement et d’usage de la plateforme UIC. 

### Configuration du service
La configuration du service uic-core s’effectue de deux manières :
- Au moment de l’installation de UIC, à l’aide du fichier uic.cfg. Cette méthode est décrite dans le document intitulé ‘’UIC_Guide_Installation’’ livré avec le produit.
- Après l’installation, si vous souhaitez reconfigurer le service, vous avez deux moyens pour le faire :
	- Utiliser l'outil standard dpkg-reconfigure. C’est cette méthode qui est préconisée, elle est détaillée dans les prochains paragraphes,
	- Editer et modifier directement les fichiers de configuration appropriés. N’utilisez cette méthode qu’en dernier recours et uniquement si vous maîtrisez la portée des modifications que vous faîtes.

#### Fichiers de configuration
Les données de configuration de uic-core sont classées en deux catégories :
- Les données de configuration de l’environnement, caractérisant l’environnement d’exécution de uic-core. Ces données sont placées dans des fichiers contenus dans le dossier /etc/default/uic-core. Elles ne changent que si l’environnement d’exécution change. En revanche une mise à jour de UIC n’aura pas d’impact sur ces données.
- Les données de configuration interne au service. Ces données sont contenues dans des fichiers placés dans le répertoire /etc/uic-core.

#### Fichiers de configuration de l’environnement
Les fichiers de configuration de l’environnement de uic-core sont placés dans le répertoire /etc/default/uic-core. Ces fichiers ne doivent pas être modifiés directement. Il est conseillé d’utiliser l’outil dpkg-reconfigure pour effectuer les changements souhaités.
La commande suivante permet de reconfigurer le service uic-core : 
```bash
sudo dpkg-reconfigure uic-core
```
L’outil affiche alors l’écran suivant :
![Image](/img_fr/img_UIC_Guide_Exploitation/image007.png#bordered)

Comme il est explicité dans cet écran, le mode ‘standalone’ signifie que la plateforme n’a qu’un seul nœud UIC. Le mode ‘shared’ signifie que la plateforme peut avoir plusieurs nœuds UIC, mais qui partagent les éléments suivants :
- Un répertoire unique /srv/uic/run, 
- Un service uic-ca-server unique,
- Une base de données Redis unique. 
En mode ‘standalone’ le service uic-core peut être configuré pour des communications en local, dans ce cas les services UIC n’écoutent pas l’interface réseau extérieure et la communication se fait via des sockets UNIX. En mode ‘shared’ il est nécessaire de choisir une interface réseau pour la communication des services UIC. 

Une fois que le mode de fonctionnement est sélectionné, vous passez à la configuration des options réseau, à l’aide de l’écran suivant : 

![Image](/img_fr/img_UIC_Guide_Exploitation/image008.png#bordered)

 UIC vous propose de sélectionner l’option d’interface réseau que vous souhaitez :
- Si vous avez choisi le mode ‘standalone’, vous pouvez sélectionner ‘None’ si vous souhaitez que les services UIC n’acceptent que les communications locales.
- Autrement, sélectionnez l’adresse IP et l’interface que vous souhaitez pour les communications avec ce noeud. 

##### Sélection des connecteurs Cloud
Une fois que vous avez choisi le mode de fonctionnement de la plateforme UIC (standalone ou sharde) et que vous avez choisi les options d’interfaces réseau, UIC affiche l’écran qui présente la liste des connecteurs Cloud disponibles :
![Image](/img_fr/img_UIC_Guide_Exploitation/image009.png#bordered)

Sélectionnez les connecteurs Cloud que vous souhaitez activer sur la plateforme, puis validez.
Après votre validation, UIC vous propose de spécifier l’emplacement du dépôt de l’agent UIC.  

##### Dépôt de l’agent UIC
Vous pouvez indiquer l’emplacement du dépôt de l’agent UIC si vous avez mis en place un dépôt spécifique. Autrement, gardez l’emplacement proposé par UIC et validez :  
![Image](/img_fr/img_UIC_Guide_Exploitation/image010.png#bordered)

Après validation, UIC vous propose de configurer la base de données Redis.

##### Configuration de la base Redis
UIC vous présente l’écran de configuration du nom ou de l’adresse IP du serveur de la base Redis. 
![Image](/img_fr/img_UIC_Guide_Exploitation/image011.png#bordered)

Indiquez l’adresse du serveur (par défaut UIC propose localhost) puis Validez. Vous obtenez ensuite l’écran de configuration du port Redis : 

![Image](/img_fr/img_UIC_Guide_Exploitation/image012.png#bordered)

Par défaut ce port est positionné à 6379. Si vous souhaitez le changer, entrez la nouvelle valeur puis validez. Vous serez ensuite invité à rentrer le mot de passe d’accès à la base Redis, à l’aide de l’écran suivant :

![Image](/img_fr/img_UIC_Guide_Exploitation/image013.png#bordered)

Si vous configurez un mot de passe d’accès à la base, il faut le configurer aussi dans le fichier ‘/etc/redis/redis.conf’ sur le serveur qui héberge la base Redis.
Si la base n’a pas de mot de passe, laissez cette ligne vide.

##### Dépôt du Coffre-fort UIC
Dans la version actuelle cette fonctionnalité n’est applicable qu’au Cloud AWS. Vous pouvez indiquer l’emplacement du dépôt du coffre-fort UIC si vous avez mis en place un dépôt spécifique. Autrement, gardez l’emplacement proposé par UIC et validez :  
![Image](/img_fr/img_UIC_Guide_Exploitation/image014.png#bordered)	 

Après validation, UIC vous propose de configurer la clé d’accès au coffre fort :
![Image](/img_fr/img_UIC_Guide_Exploitation/image015.png#bordered)

Après votre validation, la reconfiguration du service uic-core est appliquée, suivie d’un re-démarrage automatique de ce service.

#### Fichiers de configuration interne
Le fichier de configuration principal de uic-core est /etc/uic-core/uic-core.yaml. Voici un aperçu du contenu de ce fichier :
```bash
/etc/uic-core/uic-core.yaml

operator: "uic-core"
inet_publisher: "https://localhost:8086"
unix_publisher: "PUBL"
disable_unix_socket: false
uic_agent_port: 8286
https: true
rest_io:
  connect_retries: 3
  agent_response_timeout: 30000
  agent_script_response_timeout: 18000
  platform_component_response_timeout: 36000
  publisher_response_timeout: 18000
  socket_recv_timeout: 10000
  socket_send_timeout: 10000
  tcp_keepalive_cnt: 5
  tcp_keepalive_idle: 12000
  tcp_keepalive_interval: 12000
  thread_idle_timeout: 180
  rest_job_high_water_mark: 0
  rest_job_low_water_mark: 0
security:
  email: "uic-core@prologue.fr"
  crypto_key_file: "/srv/uic/run/security/crypto-keys/crypto.key"
  tls:
    libssl:
      with_sess_cache: true
      with_sess_reuse: true
      sess_cache_size: 64
      sess_cache_timeout: 180
      not_cached: "curl"
```
Ce fichier contient les sections de configuration suivantes :
- Une section de paramètres globaux indiquant notamment l’URL d’accès au service publisher. La plupart des paramètres ont des noms qui indiquent leur usage,
- Une section dite rest_io qui rassemble tous les paramètres concernant l’encadrement des temps d’attente et de nombre de tentatives de communications inter-services UIC et entre UIC et les plateformes Cloud,
- Une section Security indiquant l’emplacement et le nom de la clé de cryptage utilisée par UIC, ainsi que des paramètres associés au protocole TLS.

### La base de données uic-core
La base de données utilisée dans uic-core est Redis (REmote Dictionary Server).
L’objectif de cette base est de garder les instances des catégories gérées par la plateforme. La plateforme gère plus de 100 catégories OCCI [Open Cloud Computing Interface](http://occi-wg.org/).
La plateforme utilise ‘libhiredis, la bibliothèque client C pour la base de données Redis. Certaines opérations  sont exécutées à l’aide de scripts ‘lua’ pour augmenter les performances. Ces scripts sont installés dans ```/usr/share/uic-core/redis/```, la plateforme les charge dans la base au démarrage.

L’architecture de la plateforme est orientée micro services. Chaque micro service gère un ensemble de catégories. Un procci est une interface vis-à-vis d’un fournisseur cloud. L’accès aux instances d’une catégorie dans la base s’effectue par le service et seulement par le service qui gère cette catégorie. Cette règle permet d’organiser le verrouillage de la base, et assurer les transactions. Avec ce mode de verrouillage, la base ne peut être accédée que par les requêtes GET, PUT, POST, DELETE vers le service responsable de la catégorie.
L’administration de la base (par exemple avec l’outil UIC ‘ut_admin_redis’ ou avec l’outil standard ‘redis-cli’) ne peut être faite qu’à l’arrêt de la plateforme. 

#### Configuration de la base 
La configuration de la base Redis s’effectue à l’aide de l’outil ‘dpkg-reconfigure uic-core’ décrit dans le chapitre Configuration de la base Redis.

#### Organisation de la base
La base **uic-core** contient les objets suivants :
- Les instances des catégories : Chaque instance est un objet de type ‘hash’ dans la base et dont la clef est de format ```<pubid>:<uuid>```.
- Les links : Ces objets décrivent les liens entre les instances des catégories, leurs clefs on le format ```/link/<pubid>:<uuid>```.
- Les ‘reverse références’ - ```/rref/<pubid>:<attribut>=<value>``` : Ces objets sont utilisés pour optimiser les recherches des instances en fonction des valeurs des attributs.
- Les ‘file références’ - ```/fref/<pubid>:<uuid>``` : Ces objets contiennent les cors de fichiers comme des scripts d’installation etc.
- Les ```/heap/<pubid>:<uuid>``` : Les objets spéciaux pour garder la liste de strings attachés à l’instance. 
- Les objets spéciaux - ```/sync/<name>``` : Ces objets sont nécessaires pour le fonctionnement de la plateforme.
- Les objets temporaires - ```/temp/<pubid>:<uuid>``` : Ces objets sont créés pendant l’exécution des requêtes vers la base et doivent être effacés juste après l’exécution.
- Les objets administratifs – ‘/admin/…’, ils sont créés aux opérations administratives comme la vérification de la base.
- Les objets verrous - ```/lock/<pubid>``` : Ces objets sont destinés à verrouiller des instances qui sont en train d’être modifier. 

Les objets sont distribués sur quatre indexes de la base Redis : 0, 1, 2 et 3. Les objets spéciaux et administratifs ainsi que la plupart des instances de catégories et leurs objets associés ‘link’ et ‘rref’ sont toujours dans l’index 0. 

Dans l’index 1 se trouvent des instances d’identification et d’autorisation : ‘user’, ‘account’, ‘trust’ et toutes les instances ```<procci>_config```, ainsi que leurs objets associés ‘link’ et ‘rref’.

Dans l’index 2 se trouvent les instances de la catégorie ‘authorization’.
L’index 3 est utilisé pour les objets de tests.

#### Outil de management de la base
UIC dispose d’un outil destiné à administrer la base. Certaines commandes de l’outil (qui modifient la Base) ne peuvent être utilisées qu’avec la plateforme UIC arrêtée. 

L’outil peut être lancé en mode interactif ainsi qu’en mode de ligne de commande. 
Pour lancer l’outil en mode interactif, il faut exécuter la commande suivante dans un terminal :
```bash
sudo /usr/lib/uic-core/ut_admin_redis 
```
Pour exécuter une commande en mode de ligne de commande :
```bash
sudo /usr/lib/uic-core/ut_admin_redis -- <command> <arguments>
```
Pour obtenir en mode interactif l’aide contextuelle sur la liste de commandes tapez ```‘help’ ou ‘help <COMMAND>’``` pour une commande concrète. 

##### Commande ```check-DB```
```bash
check-DB
```
La commande effectue la vérification de cohérence de la base. 
La vérification inclut les opérations suivantes:

- La recherche des objets temporaires perdus.
- La recherche des links abandonnés (dont l’objet propriétaire n’existe pas) ou erronés (qui se pointent sur un objet inexistant). 
- La vérification des objets *rref* les clés cités doivent exister et les valeurs des attributs citées doivent correspondre. 
- La recherche des verrous perdus.
- Etc.

Les résultats de la vérification sont sauvegardés dans la base dans les clefs ```/admin/bad/<type-d’objet>```:
- /admin/bad/lock – problèmes de verrous
- /admin/bad/rref – problèmes de ‘reverse références’
- /admin/bad/fref – problèmes de ‘file références’
- /admin/bad/link – problèmes de links
- /admin/bad/temp – problèmes d’objets temporaires
- /admin/bad/strange – les clefs non reconnues

Pour lister l’ensemble des clefs créées, il faut exécuter la commande : 
```bash
redis-cli KEYS /admin/bad/*
```
Pour lister le contenu d’une clef : 
```bash
redis-cli SMEMBERS /admin/bad/<type>.
```
##### Commande ```repair-DB```
```bash
repair-DB
```
La commande effectue la réparation de la base. Il faut faire d’abord une vérification car les clefs ```/admin/bad/<type>``` servent pour la réparation. Néanmoins une procédure de réparation ne garantit pas toujours la cohérence absoute de la base. Une intervention manuelle peut être nécessaire.

##### Commande ```get-by-filter```
```bash
get-by-filter pubid [ATTRS [FILTER [...]]] 
```
La commande cherche et affiche des objets d’instances ```<pubid>```. Si les paramètres ```<ATTRS> ```sont donnés, la commande n’affiche que les attributs cités. Si les arguments ```<FILTER>``` sont donnés, les objets trouvés sont sélectionnés conformément aux filtres précisés.
Exemple :
```bash
 get-by-filter user name,email role=operator
```
Cette commande va afficher les attributs ‘name, email’ de toutes les instances ‘user’ qui ont l’attribut ‘role=operator’.
```bash
get-by-filter account name,L nature=operator
```
Cette commande va afficher l’attribut ‘name’ et tous les links de toutes les instances ‘account’ qui ont l’attribut ‘nature=operator’.

##### Commande ```purge-by-filter```
```bash
purge-by-filter pubid [FILTER [...]]
````
La commande permet d’éliminer de la base tous les objets d’instances ```<pubid>``` et leurs objets associés, les ‘links’ et les ‘rref’. Si les ```<FILTER>``` sont donnés, les objets à éliminer sont choisis en fonction du filtre.

##### Commande ```purge```
```bash
purge pubid[:uuid] [pubid[:uuid]...]
````
Si le ```<uuid>``` est donné, la commande élimine de la base l’instance ```<pubid>:<uuid>``` et ses objets associés, les links, les ‘rref et les ‘fref’. Sans ```<uuid>``` toutes les instances ```<pubid>``` et les objets associés seront éliminés.

##### Commande ```del-node-locks```
```bash
del-node-locks  [uic-core_node_ident]
```
Des objets verrous (```/lock/<pubid>```) peuvent rester dans la Base en cas d’un crash. La commande permet d’effacer tous les verrous (la commande sans argument) ou les verrous appartenant à un nœud uic-core dont l’identificateur est donné. L’identificateur de nœud se trouve dans le fichier /var/lib/uic-core/cardinal.smark sur le nœud en question.

##### Commande ```script-load```
```bash 
script-load path ident [hash]
```
La commande charge dans la base un script ‘lua’ du fichier ```<path>```. Si le ```<hash>``` est donné, le script sera enregistré dans l’objet avec la clé ```<hash>```. Par défaut la clé de ```<hash>``` est ‘/sync/scripts’. La commande est destinée plutôt au débogage.

##### Commande ```redis-cli```
```bash
redis-cli redis-cli-command-line
```
Cette commande est un emballage du client standard ‘redis-cli’. La liste de toutes les commandes du client standard est disponible sur https://redis.io/commands.
Par exemple, pour afficher le contenu de l’instance ‘agreement:e8574de4-7a90-4916-874e-63e4613ce241’il faut taper :
redis-cli HGETALL agreement:e8574de4-7a90-4916-874e-63e4613ce241

##### Commande ```bunch```
```bash
bunch view pubid:uuid
bunch purge pubid:uuid
````
Cette commande est destinée au débogage. Elle permet de visualiser (view) ou de nettoyer (purge) toute l’arborescence des objets liés avec une instance ‘pubid:uuid’.

##### Commande ```bunch-wplan```
```bash
bunch_wplan view wplan:uuid | service:uuid
bunch_wplan purge wplan:uuid | service:uuid
```
Cette commande est destinée au débogage. Elle permet de visualiser (view) ou de nettoyer (purge) toute l’arborescence des objets liés avec une instance ‘wplan’ ou ‘service’.

##### Commande ```bunch-scheduler```
```bash
bunch_scheduler view scheduler:uuid | job:uuid | hook:uuid
bunch_scheduler purge scheduler:uuid | job:uuid | hook:uuid
```
Cette commande est destinée au débogage. Elle permet de visualiser (view) ou de nettoyer (purge) toute l’arborescence des objets liés avec une instance ‘scheduler’ ou ‘job’ ou ‘hook’.

##### Commande ```desc```
```bash
desc view [term]
desc write [term]
```
La commande permet de visualiser (view) ou de réécrire (write) le descripteur d’un ‘term’ de catégorie. Les descripteurs des catégories sont dans l’objet spécial ‘/sync/desc’. En cas de réécriture des descripteurs, leur insertion dans la base se fait à partir du fichier ‘/usr/share/uic-core/db-strukt.json’.
La commande est destinée plutôt au débogage.

##### Commande ```quit```.
```bash
quit
```
Cette commande permet de quitter l’outil.

### Agent UIC
L’agent UIC est installable, en option, sur les machines virtuelles gérées par la plateforme. Il permet de : 
- Personnaliser la machine virtuelle, 
- Installer et configurer des applications. 
L’exécution des tâches par l’agent peut être déclenchée pendant les phases suivantes: 
- au démarrage de la machine virtuelle (boot), 
- à l’arrêt de la machine virtuelle (release),
- de manière interactive pendant le fonctionnement de la machine virtuelle.

Sur les plateformes Linux, l’agent UIC s’exécute sous forme d’un service.
![Image](/img_fr/img_UIC_Guide_Exploitation/image016.png#bordered)

Le fichier de log de l’agent Linux se trouve dans :
```bash
/var/lib/uicb/uicb-agent/co-log
```
Les scripts exécutés par l’agent ainsi que leurs logs d’exécution se trouvent dans le dossier :
```bash
/var/lib/uicb/uicb-agent/exec-instructions
```
Sur les plateformes Windows, l’agent UIC s’installe sous forme d’un service, comme illustré sur la figure suivante :

![Image](/img_fr/img_UIC_Guide_Exploitation/image017.png#bordered)

Le fichier de log de l’agent Windows se trouve dans :
```bash
C:\ProgramData\Prologue\UICB\co-log
```
Les scripts exécutés par l’agent ainsi que leurs logs d’exécution se trouvent dans le dossier :  
```bash
C:\ProgramData\Prologue\UICB\run\exec-instructions
```

#### Serveur de dépôt pour l’agent UIC
Par défaut un serveur est mis en place par Prologue, accessible sur le web (AWS S3). La plateforme UIC communique avec ce serveur avec HTTP(S). Ce dépôt peut être hébergé par le client dans la localisation de son choix. <br></br>
L’accès au dépôt est configurable à l’aide de ‘dpkg-reconfigure uic-core’. Ce point est décrit dans le chapitre **Dépôt de l’agent UIC**.

#### Installation et activation de l’agent
Le choix d’une installation ou non d’un agent UIC sur une VM se fait lors de la phase de configuration d’un déploiement. Pour cela UIC a prévu une case à cocher intitulée ‘’**Installer l’agent UIC**’’, accessible depuis l’onglet **Personnalisation**.<br></br> 
Si vous décidez d’installer l’agent sur une VM, prenez en compte le fait que UIC implémente un mécanisme de sécurisation des échanges entre la VM et la plateforme UIC. Ce mécanisme est basé sur une règle de pare-feu n’autorisant la communication sur le port TCP de l’agent (par défaut 8286) qu’entre la VM et la plateforme UIC. Pour cela, UIC a besoin de connaitre l’adresse IP de la plateforme UIC ou de son réseau, qui est visible à la VM. <br></br>
Cette adresse est à renseigner ou bien dans le champ **VISIBLE_IP_FROM_PUBLIC_CLOUD** du fichier uic.cfg avant de faire l’installation, ou bien dans le fichier /usr/share/uic-dashboard/.env, ou bien lors de la finalisation de l’installation interactive.

### Administration  
#### Vérification de l’état des services 
La commande suivante permet de vérifier l’état des services de la plateforme :
```bash
sudo uic-status
```
![Image](/img_fr/img_UIC_Guide_Exploitation/image018.png#bordered)

Les lignes [1-8] correspondent aux services internes de la plateforme.<br></br>
Les lignes [9-24] correspondent aux services des PROCCI, listés ci-dessous :
- proccios : interface pour OpenStack qui écoute sur le port 8104.
- proccimaz : interface pour Microsoft Azure qui écoute sur le port 8106    
- procciaws : interface pour Amazon Web Services qui écoute sur le port 8107
- procciccm : interface pour les outils de gestion de configuration qui écoute sur le port 8108     
- proccivs : interface pour vSphere qui écoute sur le port 8111     
- proccivc : interface pour vCloud qui écoute sur le port 8112     
- procciovh : interface pour le Cloud OVH qui écoute sur le port 8114     
- proccicms : interface pour les outils de monitoring service qui écoute sur le port 8115
- proccife : interface pour Orange Flexible Engine qui écoute sur le port 8116     
- proccigcp : interface pour Google Cloud Platform qui écoute sur le port 8117     
- procciipam : interface pour le service IPAM qui écoute sur le port 8118     
- procciosc : interface pour le Cloud Outscale qui écoute sur le port 8119
- procciiwh : interface pour le service webhook qui écoute sur le port 8120     
- procciitsm : interface pour les services ITSM qui écoute sur le port 8121     
- proccioci : interface pour le Cloud Oracle qui écoute sur le port 8122     
- proccifsm : interface pour le service pare-feu qui écoute sur le port 8123     

#### Arrêt des services 
La commande suivante permet d’arrêter les services de la plateforme 
```bash
sudo service uic-core stop
```
Après vérification de l’état des services, on obtient le résultat suivant
![Image](/img_fr/img_UIC_Guide_Exploitation/image019.png#bordered)

#### Démarrage des services uic-core
La commande suivante permet de démarrer les services uic-core de la plateforme 
```bash
sudo service uic-core start
```
#### Outil uic-procci
La commande suivante permet de lister tous les composants de type ‘procci’ de la plateforme avec leurs statuts :
```bash
uic-procci list
```
![Image](/img_fr/img_UIC_Guide_Exploitation/image020.png#bordered)

### Sécurité  
#### Gestion des certificats SSL
La connexion aux services uic-core s’effectue avec la présentation d’un certificat SSL. Chaque composant de la plateforme dispose d’une paire de ‘certificat/clé’ : les services en mode ‘serveur’, les clients en mode ‘client’. Les services jouent le rôle de serveur ainsi que de client.<br></br>
Les chemins complets de ‘certificat/clé’ et de l’autorité de certification pour un composant sont configurés dans la section ‘config/security/tls’ du fichier : 
```bash
/etc/uic-core/<composant>.xml
```
Le dossier ‘/srv/uic/run/security/’ stocke les certificats des différents composants de la plateforme ainsi que les certificats des agents.<br></br>
Les certificats des agents UIC sont générés pour chaque nom de compte et chacun avec sa propre autorité de certification (nommé CA dans la suite de ce document). Cela permet d’interdire l’accès au nom d’un compte tout simplement en éliminant le CA du compte en question. <br></br>
Seul les ‘proccis’ communiquent avec les agents. Dans cette communication le ‘procci’ est toujours le client et l’agent étant le serveur, ce qui exclut l’accès des agents à la plateforme. <br></br>
Afin d’accepter les agents, un ‘procci’ doit avoir l’accès à toute la liste des ‘CA’ d’agent. Cette liste se trouve dans le répertoire ‘/srv/uic/run/security/ca-cosacs’. La déclaration de cette liste d’autorités se fait dans le fichier de configuration ‘/etc/uic-core/procci[xx].yaml’ de manière suivante : 
```bash
authority_account :”/srv/uic/run/security/ca-cosacs”
```
Tandis que pour les autres services de la plateforme, la déclaration se fait avec la clé suivante :
```bash
authority: “/srv/uic/run/security/ca.crt”
```

#### Génération des certificats
La génération des certificats se fait au démarrage de la plateforme. A chaque démarrage (service uic-core start) une vérification sur les certificats est effectuée. Le script de démarrage de la plateforme vérifie à chaque démarrage la présence des certificats nécessaires et s’il le faut, la plateforme génère les certificats manquants. 

Les certificats de la plateforme UIC sont générés avec le module ‘uic-ca’.  Ce module dispose d’une architecture ‘client-serveur’. Par défaut le client et le serveur sont installés sur la même machine. Néanmoins, il est possible de les installer sur deux nœuds différents avec un partage du répertoire ‘/srv/uic/run/security’. Le client est toujours installé sur chaque nœud de uic-core. 

#### Certificats de l’agent UIC
Les certificats des agents se créent automatiquement au moment de la création d’un compte. 
Lorsque l’agent uic est installé dans une VM appartenant à un compte ```<account>``` les certificats suivants sont transférés automatiquement :
```bash
/srv/uic/run/security/ca.crt
/srv/uic/run/security/cosacs/<account>.crt (sous le nom cosacs.crt)
/srv/uic/run/security/cosacs/<account>.key (sous le nom cosacs.key)
```

#### La clé de cryptage uic-core
La plateforme *Use IT Cloud* utilise une clé de cryptage afin de crypter certaines données sensibles. La clé de cryptage est créée automatiquement à l’installation de la plateforme et se trouve dans le répertoire :
```bash
/srv/uic/run/security/crypto-keys 
````
Le mot de passe de l’administrateur est créé à l’installation, il est également crypté par cette clé.
Le chemin de la clé de cryptage est indiqué dans le fichier : /etc/uic-core/uic-core.yaml dans la section security : 
```bash  
crypto_key_file: "<path-to-file>"
```

#### Processus de remplacement de la clé de cryptage
La procédure de remplacement de la clé de cryptage est exécutée sur la machine où la plateforme est installée. <br></br>
**Remarque : La plateforme doit être arrêtée.** <br></br>
Les différentes étapes à effectuer sont les suivantes :
- Assurez-vous de la disponibilité de l’outil de remplacement de la clé
L’outil de cryptage doit être installé : /usr/lib/uic-core/ut_crypto_rotation, c’est le paquet uic-core-ut-crypto-rotation. 

##### Génération d’une nouvelle clé
La génération d’une nouvelle clé peut être effectuée à l’aide du script gen-crypto-key qui fait partie du paquet uic-core :
```bash 
	/usr/lib/uic-core/gen-crypto-key <name>
```
La clé générée est sauvegardée dans le fichier ```/srv/uic/run/security/crypto-keys/<name>```.

##### Arrêt de la plateforme UIC
Toute modification liée à la base doit se faire avec la plateforme arrêtée. 
L’arrêt de la plateforme s’effectue à l’aide de la commande suivante :
```bash 
service uic-core stop
```
#### Sauvegarde des données à recrypter
Faites un backup de la base de données uic-core. Ce backup s’effectue en copiant le fichier «.rdb» à l’emplacement de la sauvegarde.  Il faut choisir une destination pour stocker le fichier, (il est généralement plus sûr, de le transférer vers un serveur ou un disque différent).

La commande ci-dessous détermine où se trouve le fichier «.rdb» actuel
```bash
cat /etc/redis/redis.conf |grep '^dir '|cut -d' ' -f2
```
Par défaut, ce dossier est « /var/lib/redis ». Avant d’effectuer la copie, sauvegardez la base de données en arrière-plan.
```bash 
redis-cli bgsave
```

Une fois la sauvegarde terminée, copiez le fichier dump.rdb dans un emplacement garanti (le chemin /backup/redis est indiqué à titre d’exemple)
```bash 
cp /var/lib/redis/dump.rdb /backup/redis/dump.$(date +%Y%m%d%H%M).rdb
```
#### Exécution de l’outil de rotation
Vous devez saisir la ligne de commande ci-dessous : 
```bash 
/usr/lib/uic-core/ut_crypto_rotation --key <new_key_path>
```
Cette commande exécute les actions suivantes :
- Récupération du chemin de la clé actuelle dans le fichier suivant : */etc/uic-core/uic-core.yaml* pour savoir l’emplacement de la base.
- Recryptage de tous les attributs cryptés dans la base de données uic-core.
- Renommage de l’ancienne clé ajoutant l’extension « .backup »
- Copie de la nouvelle clé (à la place de l’ancienne). 
![Image](/img_fr/img_UIC_Guide_Exploitation/image021.jpg#bordered)

La procédure a fonctionné, le message « Crypto Key Rotation : SUCCESS. » s’affichera. 
La plateforme peut être démarrée avec la nouvelle clé, exécutez la commande :
```bash
service uic-core start
```
Dans le cas contraire, la procédure a échoué, vous devrez restaurer les données sauvegardées.

### Gestion des Logs
La gestion des logs des services UIC core se fait de deux manières :
- Les traces concernant les phases d’installation ou de mise à jour sont enregistrées directement dans le fichier /var/log/uic-core.log
- Les traces concernant la phase d’exploitation de uic-core sont enregistrées via le service ‘rsyslog’. Les détails sur la configuration de ce service ainsi que les fichiers de logs utilisés par uic-core sont fournis dans les prochains paragraphes. <br></br>
L’agent UIC ‘cosacs’ utilise le ‘simple log’ – le fichier ‘co-log’ écrit par lui-même. Chaque message de log commence par le niveau de sa ‘severity’ : ERROR, WARNING, NOTICE, INFO, DEBUG

#### Configuration de rsyslog
L’installation de la plateforme UIC fournit les configurations suivantes pour **rsyslog **:
- Les logs dans des fichiers dans le répertoire local ‘/var/log/uic-core’ (**par défaut**)
- Les logs dans la Base **MySQL**
- Les logs envoyés vers un autre serveur **rsyslog**

Il est permis d’installer une ou plusieurs configuration(s) à la fois. Il est possible d’avoir en même temps les logs dans les fichiers, la base MySQL, est envoyés vers un autre serveur **rsyslog**.
Pour en savoir davantage sur la configuration de **rsyslog**, voir http://www.rsyslog.com/ ou bien sur la console :
```bash
man 5 rsyslog.conf
```

#### Logs de la phase d’exploitation de uic-core 
Par défaut UIC utilise la configuration rsyslog dans le fichier indiqué ci-dessous. La configuration est installée à partir du paquet ‘uic-rsyslog-file-conf’. La configuration est dans le fichier suivant :
```bash
/etc/rsyslog.d/10-uic-file.conf
```
La configuration gère les fichiers suivants :
- /var/log/uic-core/uic-core.log : le log principal, cumule tous les messages
- /var/log/uic-core/error.log : messages d’erreurs
- /var/log/uic-core/notice.log : le log des messages de notification des déploiements

#### Comment vérifier le passage des messages ?
Pour tester le passage d'un message log on peut exécuter la commande suivante :
```bash
logger -t uic-test -p user.info -- TEST message
```
Le message doit apparaitre dans le fichier ```/var/log/uic-core/uic-core.log```.

#### Logrotate
Logrotate permet de limiter la taille des fichiers journaux présents dans /var/log.<br></br>
Pour chaque fichier journal, logrotate réalise 2 opérations simultanées :
- la **rotation** : il archive le fichier journal sous un autre nom et supprime la plus ancienne archive
- la **compression** : il compresse éventuellement le fichier journal avant de l'archiver
Les informations spécifiques à la journalisation de l’applications *Use IT Cloud* sont conservées dans le fichier : 




```bash
/etc/logrotate.d/uic-core
/var/log/uic-core/*.log {
  daily
  missingok
  rotate 10
  compress
  delaycompress
  size 4M
  sharedscripts
  postrotate
    killall -HUP rsyslogd
  endscript
}
```
- **Daily** : Intervalle de rotation, la rotation s’effectuera tous les jours. Nous pouvons aussi mettre weekly pour toutes les semaines, monthly pour tous les mois. 
- **missingok** : Permets au processus de ne pas s'arrêter à chaque erreur et de poursuivre avec le fichier de log suivant.
- **rotate 10** : Nous garderons 10 fichiers, soit dans ce cas, 10 jours de logs.
- **compress** : Les fichiers de logs sont compressés au format gzip si cette commande est spécifiée, 
- **delaycompress** : Retarde le processus de compression jusqu'à la prochaine rotation. 

**Attention : delaycompress ne fonctionnera que si l'option compress est clairement spécifiée.**

- si **size** et **rotation** sont spécifiés ensemble, size prend la priorité. La rotation dans l’exemple par défaut se fera dès lors que le fichier de logs atteint les 4M et ce, sans attendre la prochaine rotation journalière.
- **sharedscripts** : permet de n’exécuter qu’une fois le script postrotate par rotation.
- **prerotate/endscript** : Les lignes entre prerotate et endscript (chacun devant apparaître sur une ligne isolée) sont exécutées avant la permutation du journal. Ces directives doivent apparaître dans la définition d’un journal.


## API UIC
L’API de *Use IT Cloud* est développée en Python, avec le micro-framework Flask, qui fonctionne avec toute version d’Apache qui prend en charge la gestion du module mod_wsgi.

### Configuration pour apache
La commande suivante permet d’installer et d’activer le module **mod_wsgi**
```bash
sudo apt-get install libapache2-mod-wsgi 
```
Après avoir installé et activé mod_wsgi, modifiez le fichier uic-ssl.conf qui se trouve à l’emplacement suivant :
```bash
/etc/apache2/sites-enabled/uic-ssl.conf

<VirtualHost _default_:443>    
   . . .
# ---- Configure WSGI Listener(s) ----
WSGIDaemonProcess uicapiprocess user=www-data group=www-data threads=5 processes=1
WSGIScriptAlias /api /usr/share/uic-api/api/uicapiwsgi.py
WSGIPassAuthorization On
<Directory /usr/share/uic-api/api>
      WSGIProcessGroup uicapiprocess
      WSGIApplicationGroup %{GLOBAL}
      WSGIScriptReloading On
      Require all granted
</Directory>
   . . .
</VirtualHost>
```
La ligne WSGIScriptAlias est l’URL de base à laquelle vous souhaitez servir votre application (/api indique l’URL racine) ; le second élément est l’emplacement d’un « fichier WSGI » de notre système, dans notre cas le fichier se trouve dans :
```bash
/usr/share/uic-api/api/uicapiwsgi.py
```
Cela indique à Apache qu’il doit servir toute requête au-dessous de l’URL donnée en utilisant l’application WSGI définie dans ce fichier.<br></br>
L’élément ```<Directory>``` ne sert qu’à garantir qu’Apache ait accès à votre fichier ‘uicapiwsgi.py’.
L’option « WSGIPassAuthorization » permet à l’application de recevoir les headers nécessaires à l'authentification des utilisateurs.

Le « mode daemon » est le mode recommandé pour le fonctionnement de mod_wsgi (sur les plates-formes non Windows). Pour créer le groupe de processus daemon nécessaire et y installer l’instance Flask. Nous ajoutons les directives WSGIDaemonProcess et WSGIProcessGroup appropriées, ‘*uicapiprocess*’ dans notre cas. 

Pour démarrer l’API, nous avons besoin de créer un fichier .wsgi. Ce fichier doit simplement se charger d'importer l'instance de notre application :
```bash 
/usr/share/uic-api/api/uicapiwsgi.py

#!/usr/bin/python
import sys, os
abspath = os.path.dirname(__file__)
sys.path.append(abspath)
os.chdir(abspath)
sys.path.append("/usr/share/uic-api/python")

from uicapi.app.app import create_app
application = create_app()
````
### Permissions sur le dossier API
Le répertoire ci-dessous doit être accessible en écriture par le serveur Web (www-data pour apache). 
```bash
sudo chown -R www-data:www-data /usr/share/uic-api/api
```

### Configuration des logs de l’API
Les fichiers de logs de l’api UIC se trouvent dans le dossier :
```bash
/usr/share/uic-api/api/log/
```
La rotation du log de l’API se fait au niveau du fichier de configuration suivant :
```bash
/usr/share/uic-api/api/config/uic.config

log_size=1024*1024*20
log_when='D'
log_backup=10
```
- **log_size** : Taille en octet, dès lors que le fichier de logs atteint la taille spécifiée (dans notre cas 20 méga-octets) une rotation sera effectuée.
- **log_when** : Intervalle de rotation, les valeurs possibles sont : 
	-	'S' : 	Seconds
	-	'M' : 	Minutes
	-	'H' : 	Hours
	-	'D' : 	Days
	-	'W0'-'W6' : Weekday (0=Monday)
	-	'midnight’ : Roll over at midnight
- **log_backup** : correspond à la rétention des logs, 10 jours de logs dans notre cas.

### Accès à l’API
L’accès à l’API UIC est autorisé à des utilisateurs ayant un profil Administrateur API ou Utilisateur API. Le profil Administrateur API contrôle toutes les ressources déployées sur son compte. Le profil Utilisateur API contrôle uniquement ses propres ressources.<br></br>
Si vous n’avez pas encore créé d’utilisateur ayant l’un des deux profils, voici la procédure à suivre pour en créer un.

#### Création d’un utilisateur d’API
Pour créer un utilisateur ayant les privilèges nécessaires pour accéder à l’API UIC, suivez les instructions ci-dessous :
- Connectez-vous au portail UIC en tant qu’administrateur ou utilisateur ayant les permissions de créer d’autres utilisateurs.
- Cliquez sur le menu ```<Compte:Utilisateur>```  Utilisateurs. 
- Cliquez sur le bouton de commande **Créer un nouvel utilisateur**. Vous obtenez le formulaire de création d’un nouvel utilisateur comme illustré sur l’écran suivant :
![Image](/img_fr/img_UIC_Guide_Exploitation/image022.png#bordered)

- Cliquez sur la liste *Type* et choisissez *Administrateur de compte* ou **Utilisateur régulier**, le bouton **Activer l’API** apparaît comme illustré sur l’écran suivant :
 
![Image](/img_fr/img_UIC_Guide_Exploitation/image023.png#bordered)

- Renseignez les autres champs habituels d’identification de l’utilisateur.
- Cliquez sur le bouton **Créer** pour terminer l’opération.

#### Identifiant d’authentification
L’accès à l’API d’une plateforme UIC peut se faire à l’aide d’un navigateur web, à l’URL suivante : 
```bash
https://@UIC/api/docs/. 
```
Lorsque vous composez cet URL, UIC affiche la page suivante :
![Image](/img_fr/img_UIC_Guide_Exploitation/image024.png#bordered)

Avant de pouvoir composer des requêtes, vous devez déclarer les paramètres d’authentification qui seront utilisés pour les échanges avec le serveur d’API. Voici les étapes à suivre : 
- Cliquez sur le bouton **Authorize**, l’écran suivant s’affiche : 
![Image](/img_fr/img_UIC_Guide_Exploitation/image025.png#bordered)
 

UIC propose deux méthodes d’authentification : 
- Une méthode basée sur un identifiant utilisateur et un mot de passe. Si vous choisissez cette méthode, complétez les zones **username** et **Password.** Pour rappel cet utilisateur doit avoir un profil Administrateur API ou Utilisateur API. Actuellement, dans UIC, c’est l’adresse mail qui identifie de manière unique un utilisateur, par conséquent, le champ username doit contenir une adresse mail valide.
- Une méthode basée sur l’usage d’un jeton d’accès généré par le service API. L’obtention d’un jeton se fait par la requête **GET** sur la ressource **token** de l’API et le bouton **Try it out**. Le service vous demande alors de rentrer un identifiant d’utilisateur et un mot de passe. Comme pour la première méthode, entrez une adresse mail valide d’un utilisateur ou administrateur d’API, son mot de passe, puis validez. En cas de succès, le service d’API vous affiche la valeur du jeton dans le champ **token** de la réponse à la commande **Try it out**. Copiez la valeur affichée puis insérez la dans le champ **value** de la section **API key authorization**.
 
Cliquez sur le bouton **Authorize**, pour obtenir l’autorisation d’accès à l’API UIC. 

#### Utilisation de l’API
Une fois que vous avez validé votre identifiant d’authentification, vous pouvez utiliser l’API exposé par UIC. Dans cette version, UIC expose cinq catégories de ressources de premier niveau, leur description est fournie dans le tableau ci-dessous :

Catégorie de ressource | Description
-----------------------|---------------------
agreement	 	| Catégorie représentant un déploiement UIC de façon globale
provider	 	| Catégorie utilisée pour représenter et gérer les ressources d’un fournisseur de Cloud
service	 		| Catégorie utilisée pour représenter toutes les ressources provisionnées pour un déploiement 
server	 		| Catégorie représentant une machine virtuelle
token			| Catégorie représentant un jeton d’accès à l’API

Toutes ces catégories sont décrites dans la documentation dédiée à l’API UIC. Cette documentation peut être obtenue sur simple demande.

## Utilisation des scripts de backup et de restauration des données UIC 
UIC fournit des scripts de sauvegarde et de restauration des données d’une installation UIC. Cela permet d’effectuer des sauvegardes régulières en prévision d’éventuelles situations nécessitant une restauration d’un état des bases de données de la plateforme UIC remontant à une date donnée et une heure précise. Les deux scripts dédiés à cette fonctionnalité sont disponibles en téléchargement aux emplacements suivants : 
```bash
https://uicpackages.s3.eu-west-3.amazonaws.com/update/backup-uic-with-rsync.bash

https://uicpackages.s3.eu-west-3.amazonaws.com/update/restore-uic-with-rsync.bash
```
Ces scripts ne sont pas automatiquement installés lors du processus d’installation de UIC. Si vous souhaitez les utiliser, veuillez les télécharger en suivant ces instructions :
 
- Connectez-vous au serveur qui héberge le portail UIC 
- Exécutez la commande suivante :
```bash
sudo su 
```
- Téléchargez les deux scripts bash indiqués ci-dessus, et rendez-les exécutables, par exemple à l’aide du script suivant : 
```bash
#!/bin/bash
scriptsLocation="https://s3.eu-west-3.amazonaws.com/uicpackages/update"
backupScript=${scriptsLocation}/backup-uic-with-rsync.bash
restoreScript=${scriptsLocation}/restore-uic-with-rsync.bash
wget ${backupScript} ${restoreScript}
chmod 700 backup-uic-with-rsync.bash restore-uic-with-rsync.bash
```
- Placez ces scripts dans un répertoire approprié de la variable PATH.
Le mode d’utilisation de ces deux scripts est décrit en détails dans les sections suivantes.

### Sauvegarde des données UIC
Toutes les commandes lancées ci-dessous doivent être effectuées depuis le compte root. En effet certains répertoires et certains fichiers ne sont accessibles qu’à l’utilisateur root, par conséquent les opérations de positionnement d’attributs, de propriétaires et de groupes ne peuvent être effectuées avec ce compte. 
- Exécutez la commande sudo su avant de lancer les sauvegardes et les restaurations.
Le script de sauvegarde des données UIC s’appelle : ```backup-uic-with-rsync.bash```, 
Le script de la restauration s’appelle : r```estore-uic-with-rsync.bash```. 

Ces scripts peuvent être placés dans le répertoire qui vous convient. Cependant, avant de les exécuter, assurez-vous qu’ils sont exécutables et que le répertoire qui les contient est inclus dans la variable PATH. A défaut vous devez indiquer le chemin absolu vers ces scripts au niveau de la ligne de commande. 

Nous poursuivons en considérant que la variable PATH contient le chemin vers l’emplacement de ces scripts.  

#### Utilisation générale
```bash 
backup-uic-with-rsync.bash [-d <backup/Dest/Dir>] [-r <remote Host>] [-t] [-k sshprivatekey] [-b mysqldatabase] [-u mysqluser] [-p mysqlpassword] [-n] [-h]
```
- -d	Indique le répertoire racine de sauvegarde (Par défaut le script utilise /var/uicbackup).
- -r	Indique le serveur de sauvegarde (Par défaut la sauvegarde s’effectue en local).
- -k 	Indique la clef privée ssh à utiliser en cas de sauvegarde sur une autre machine avec ssh (Par défaut le script cherche la clef /root/.ssh/uicbackup).
- -b 	Indique le nom de la base mysql (Par défaut, le script utilise celui du fichier .env).
- -u 	Indique le nom de l’utilisateur mysql (Par défaut, le script utilise celui du fichier .env).
- -p 	Indique le mot de passe mysql de l’utilisateur uic (le script utilise celui du fichier .env).
- -t 	Indique au script d’horodater la sauvegarde. Le nom complet du répertoire de sauvegarde sera alors composé du nom indiqué avec l’option -d, suivi du caractère ‘.’ Suivi de la date et l’heure de création de la sauvegarde.
	Par exemple, si vous avez indiqué ‘’-d /var/uicbackup’’, et que vous avez effectué une sauvegarde le 22/01/2019 à 20H30, le répertoire de sauvegarde sera nommé /var/uicbackup.201901222030.
- -n 	Indique que la sauvegarde sera exécutée en mode ‘’dry-run’’.
- -h 	Affiche l’aide en ligne du script.

Tous les paramètres sont optionnels, en conséquence si vous lancez ce script sans fournir de paramètres, la sauvegarde sera effectuée dans le répertoire ```/var/uicbackup``` de la machine UIC locale, l’utilisateur et le mot de passe d’accès à la base de données seront ceux indiqués dans le fichier .env de la plateforme UIC.

#### Sauvegarde locale 
Lorsqu’une sauvegarde locale est effectuée, il n’y a pas besoin des options -r (remote host) et -k (sshprivatekey).
Exemples de sauvegardes sur la machine locale : 
```bash 
backup-uic-with-rsync.bash -d /var/uicArchive -p <mot de passe mysql>
```
Cette commande effectuera la sauvegarde des données UIC dans le répertoire local /var/uicArchive
```bash 
backup-uic-with-rsync.bash -d /var/uicArchive -t -p <mot de passe mysql>
```
Cette commande effectuera la sauvegarde des données UIC dans le répertoire local ```/var/uicArchive.<dateetheuredesauvegarde>```

#### Sauvegarde sur un serveur externe
La sauvegarde des données UIC sur un serveur externe nécessite une connexion ssh sécurisée avec des clefs publiques/privées. Elle nécessite également une configuration du serveur ssh pour permettre une sauvegarde automatique, sans intervention manuelle.

#### Configuration ssh
Si vous n’avez pas encore mis en place le mécanisme de connexion ssh avec les clefs entre les deux machines, voici la procédure à suivre pour le faire :

##### Génération des clefs sur la machine UIC 
```bash
ssh-keygen -f /root/.ssh/uicbackup
```
Ne pas rentrer le mot de passe lorsque cette commande vous le demande, sinon vous serez contraint de le rentrer à chaque fois que la connexion s’effectuera depuis le serveur ssh.<br></br>
Cette commande va générer deux fichiers :<br></br>
La clef privée ssh dans le fichier /root/.ssh/uicbackup<br></br>
La clef publique ssh dans le fichier /root/.ssh/uicbackup.pub

La clef /root/.ssh/uicbackup.pub doit être copiée sur la machine de sauvegarde et incluse dans le fichier /root/.ssh/authorized_keys, en utilisant par exemple la commande :
```bash
ssh-copy-id -i ~/.ssh/uicbackup.pub remote-host
````
##### Configuration de la machine de sauvegarde
Si vous souhaitez effectuer des sauvegardes automatiques sans que le serveur ssh vous demande le mot de passe, vous devez également configurer le serveur ssh de la machine afin d’accepter sans faire appel à la saisie du mot de passe au moment de la connexion à la machine UIC. <br></br>
Voici un exemple de configuration :
- Éditez le fichier de configuration /etc/ssh/sshd_config de la machine distante de sauvegarde puis ajouter ou modifier les paramètres suivants :
	```bash
	PermitRootLogin without-password
	PubkeyAuthentication yes
	AllowUsers root
	PasswordAuthentication no
	```
- Redémarrez le service ssh avec la commande ‘’service ssh restart’’ ou ‘’service ssh reload’’ pour prendre en compte la configuration modifiée.
Pour tester, le bon fonctionnement de la configuration, accomplissez la commande suivante sur la machine UIC :
```bash
ssh remote-host
```
Si la configuration est correcte, vous serez connecté sans que le serveur ne vous demande de mot de passe.

#### Exécution de la sauvegarde
Pour effectuer la sauvegarde sur une machine externe, vous devez :
- Indiquer l’adresse IP ou le nom de la machine de sauvegarde,
- Indiquer le nom de la clef privée ssh à utiliser si elle est différente de /root/.ssh/uicbackup. 
Exemples de sauvegardes sur une machine externe : 
```bash
backup-uic-with-rsync.bash -r 192.168.1.10 -d /var/uicArchive -p "mot de passe mysql"
```
Cette commande effectuera la sauvegarde des données UIC sur la machine 192.168.1.10, dans le répertoire /var/uicArchive de cette machine.
```bash
backup-uic-with-rsync.bash -r 192.168.1.10 -d /var/uicArchive -t -p "mot de passe mysql"
```
Cette commande effectuera la sauvegarde des données UIC sur la machine 192.168.1.10, dans le répertoire /var/uicArchive.dateetheuredesauvegarde

### Restauration des données UIC
Toutes les commandes lancées ci-dessous doivent être effectuées depuis le compte root. <br></br>
En effet certains répertoires et certains fichiers ne sont accessibles qu’à l’utilisateur root, par conséquent les opérations de positionnement d’attributs, de propriétaires et de groupes ne peuvent être effectuées avec ce compte. 
- Exécutez la commande sudo su avant de lancer les sauvegardes et les restaurations.

#### Utilisation générale 
Obtenir le script de https://uicpackages.s3.eu-west-3.amazonaws.com/update/restore-uic-with-rsync.bash
```bash
restore-uic-with-rsync.bash [-d "backup/Source/Dir"] [-r "remote Host"] [-k sshprivatekey] [-b mysqldatabase] [-u mysqluser] [-p mysqlpassword] [-n] [-h]
```
- -d 	Indique le répertoire racine de restauration (Par défaut le script utilise /var/uicbackup).
- -r 	Indique le serveur de sauvegarde (Par défaut la restauration s’effectue en local).
- -k 	Indique la clef privée ssh à utiliser en cas de sauvegarde sur une autre machine avec ssh (Par défaut le script cherche la clef /root/.ssh/uicbackup).
- -b 	Indique le nom de la base mysql (Par défaut, le script utilise celui du fichier .env).
- -u 	Indique le nom de l’utilisateur mysql (Par défaut, le script utilise celui du fichier .env).
- -p 	Indique le mot de passe mysql de l’utilisateur uic (Par défaut, le script utilise prologue).
- -n 	Indique que la restauration sera exécutée en mode ‘’dry-run’’.
- -h 	Affiche l’aide en ligne du script.

Tous les paramètres sont optionnels, en conséquence si vous lancez ce script sans fournir de paramètres, la restauration sera effectuée à partir du répertoire /var/uicbackup de la machine UIC locale, l’utilisateur et le mot de passe d’accès à la base de données seront ceux indiqués dans le fichier .env de la plateforme UIC s’il existe. Si ce fichier n’existe pas, l’utilisateur par défaut et le mot de passe par défaut peuvent être positionnés dans le script lui-même ou alors fournis en paramètres de ligne de commande.

#### Restauration locale
Lorsque que vous réalisez une restauration depuis une sauvegarde locale, il n’y a pas besoin des options -r (remote host) et -k (sshprivatekey).<br></br>
Exemples de restauration d’une sauvegarde locale : 
```bash
restore-uic-with-rsync.bash -d /var/uicArchive -p "mot de passe mysql"
```
Cette commande effectuera la restauration des données UIC depuis le répertoire local /var/uicArchive

#### Restauration d’une sauvegarde externe 
En cas de restauration depuis une sauvegarde externe, vous devez : 
- Indiquer l’adresse IP ou le nom de la machine de sauvegarde
- Indiquer le nom de la clef privée ssh à utiliser si elle est différente de /root/.ssh/uicbackup. 
Exemples de restauration d’une sauvegarde sur une machine externe : 
```bash
restore-uic-with-rsync.bash -r 192.168.1.10 -d /var/uicArchive -p "mot de passe mysql"
```
Cette commande effectuera la restauration des données UIC sauvegardées dans le répertoire :
```bash
/var/uicArchive de la machine 192.168.1.10.
```

### Sauvegarde et restauration sur AWS S3
Vous pouvez effectuer des sauvegardes des données UIC dans un emplacement Cloud puis restaurer les données depuis cet emplacement. Nous décrivons ici un exemple de sauvegarde et restauration sur AWS S3.<br></br>
Notez qu’il vous faut un compte Amazon AWS ayant des droits d’accès au service S3 et ayant des permissions de lecture et d’écriture sur les compartiments (buckets) S3 où vous envisagez de stocker les sauvegardes. 

#### Démarche pour la sauvegarde 
La sauvegarde des données UIC sur AWS S3 se déroule en deux étapes. La première consiste à effectuer la sauvegarde sur la plateforme UIC, à l’aide de la procédure décrite dans le chapitre Sauvegarde locale de ce document.<br></br>
La deuxième étape consiste à créer une archive, la sécuriser puis la transférer dans un bucket S3. Le bucket doit être créé et paramétré sur S3 avec les autorisations requises au préalable. Voici un exemple de script bash effectuant ces opérations. Ce script utilise les commandes tar, gpg et s3cmd, que vous devez bien entendu avoir installé sur votre machine :
```bash 
#!/bin/bash
tarFileName=uicbackup.tar
srcPath=/var/uicbackup
if [ "$1" != "" ]; then
	tarFileName=$1
fi
if [ "$2" != "" ]; then
	srcPath=$2
fi

tar -cpf ${tarFileName} ${srcPath}
gpg -ac -o ${tarFileName}.secure ${tarFileName}
file=${tarFileName}.secure 
bucket=backupuic
regionParam=’--region us-east-1’
credParams=’--access_key <XXXXXXXXX> --secret_key <YYYYYYYYYYYYY>’
s3cmd put $file s3://${bucket} ${regionParam} ${credParams}
```
La commande gpg vous invitera à rentrer un mot de passe de protection de l’archive ainsi que la confirmation de ce mot de passe.

Cet exemple est destiné à vous guider dans vos démarches de sauvegarde. Vous pouvez vous en inspirer pour créer des sauvegardes qui conviennent à vos cas d’usage.

#### Démarche pour la restauration 
La restauration des données UIC depuis un bucket AWS S3 se déroule en deux étapes. La première consiste à récupérer l’archive depuis le bucket de sauvegarde sur la plateforme UIC et la décompresser dans un répertoire local à la plateforme. Voici un exemple de script qui effectue cette procédure :
```bash 
#!/bin/bash
localTarFile=uicbackup.tar
localDestPath=/
s3File=uicbackup.tar.secure
localGPGFile=${s3File}
bucket=uicbackup
filePath="${bucket}/${s3File}"
regionParam=’--region us-east-1’
credParams=’--access_key <XXXXXXXXX> --secret_key <YYYYYYYYYYYYY>’
s3cmd get s3://${filePath} ./${localGPGFile} ${regionParam} ${credParams}
gpg -o $localTarFile $localGPGFile
tar -xpf ${localTarFile} -C ${localDestPath} 
```
La deuxième étape consiste à restaurer la sauvegarde préparée par la procédure ci-dessus, à l’aide de la procédure décrite dans le chapitre Restauration locale de ce document.

#### Utilisation de scripts prédéfinis 
La sauvegarde et restauration des données UIC sur AWS S3 peuvent être effectuées à l’aide de scripts exemples dédiés à cette fonctionnalité et qui sont disponibles en téléchargement aux emplacements suivants : 
```bash 
https://uicpackages.s3.eu-west-3.amazonaws.com/update/backup-uic-to-s3.bash
https://uicpackages.s3.eu-west-3.amazonaws.com/update/restore-uic-from-s3.bash
````
Notez que vous avez besoin également des deux scripts décrits dans les sections précédentes, à savoir : 
```bash 
https://uicpackages.s3.eu-west-3.amazonaws.com/update/backup-uic-with-rsync.bash
https://uicpackages.s3.eu-west-3.amazonaws.com/update/restore-uic-with-rsync.bash
```
Ces scripts ne sont pas automatiquement installés lors du processus d’installation de UIC. Si vous souhaitez les utiliser, veuillez les télécharger en suivant ces instructions :
- Connectez-vous au serveur qui héberge le portail UIC 
- Exécutez la commande suivante :
```bash 
sudo su 
```
- Téléchargez les scripts bash indiqués ci-dessus, et rendez-les exécutables, par exemple à l’aide du script suivant : 
```bash 
#!/bin/bash
scriptsLocation="https://s3.eu-west-3.amazonaws.com/uicpackages/update"
backupScript=${scriptsLocation}/backup-uic-with-rsync.bash
restoreScript=${scriptsLocation}/restore-uic-with-rsync.bash
wget ${backupScript} ${restoreScript}
chmod 700 backup-uic-with-rsync.bash restore-uic-with-rsync.bash

s3backupScript=${scriptsLocation}/backup-uic-to-s3.bash
s3restoreScript=${scriptsLocation}/restore-uic-from-s3.bash
wget ${s3backupScript} ${s3restoreScript}
chmod 700 backup-uic-to-s3.bash restore-uic-from-s3.bash
```
- Placez ces scripts dans un répertoire approprié de la variable PATH.
Le mode d’utilisation de ces scripts est décrit en détails dans les sections suivantes.

##### Script backup-uic-to-s3 
Ce script effectue les opérations de sauvegarde des données UIC en local, crée une archive au format « tar », encrypte cette archive, puis la transfère sur S3. Le script utilise également le script backup-uic-with-rsync.bash. La syntaxe de lancement du script est la suivante : 
```bash
backup-uic-to-s3.bash [-a access_key] [-s secret_key] [-b bucket] [-f file] [-r region] [-h]
```
- -a 	Indique la clef d’accès au service S3
- -s 	Indique la clef secrète pour l’accès au service S3
- -b 	Indique le compartiment de sauvegarde
- -r 	Indique la région du compartiment de sauvegarde
- -f 	Indique le nom du fichier de sauvegarde
- -h 	Affiche l’aide en ligne du script.

##### Script restore-uic-from-s3 
Ce script effectue les opérations de téléchargement de l’archive des données UIC depuis S3, décrypte et décompresse cette archive, puis restaure les données sur la machine locale. Le script utilise également le script restore-uic-with-rsync.bash. La syntaxe de lancement du script est la suivante : 
```bash
restore-uic-from-s3.bash [-a access_key] [-s secret_key] [-b bucket] [-f file] [-r region] [-h]
```
- -a 	Indique la clef d’accès au service S3
- -s 	Indique la clef secrète pour l’accès au service S3
- -b 	Indique le compartiment de sauvegarde
- -r 	Indique la région du compartiment de sauvegarde
- -f 	Indique le nom du fichier à restaurer
- -h 	Affiche l’aide en ligne du script.

### Restauration de la licence UIC
Lorsque vous effectuez la restauration des données sur une machine ayant les mêmes caractéristiques réseau (adresse IP, nom de domaine, adresse MAC, etc.) que la machine sauvegardée, la licence de cette machine reste valable si la date de validité n’est pas expirée. La machine fonctionnera donc normalement avec la licence restaurée. 

En revanche si vous effectuez la restauration sur une machine différente de celle de la sauvegarde, il est nécessaire de demander une licence pour cette nouvelle machine.
